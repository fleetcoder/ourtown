<!DOCTYPE html>
<html>
  <head><meta charset=utf-8>
    <meta name=viewport content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="imagetoolbar" content="no" />

    <title>rp.ly</title>

    <link href=/file/app.0dcb9922d69daabe8848.css rel=stylesheet>
    <script type=text/javascript src=/file/manifest.2ae2e69a05c33dfc65f8.js></script>
    <script type=text/javascript src=/file/vendor.0eb5480a7e9a156e90f2.js></script>
    <script type=text/javascript src=/file/app.5bebe20bf1bba69db56d.js></script>
    <!-- <script type=text/javascript src=/file/socket.io.js></script> -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/file/rply57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/file/rply72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/file/rply114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/file/rply144.png" />
  </head>
  <body>

    <div id="app"><router-view class="view"></router-view></div>

    <!-- pallette: 222831 393e46 32e0c4 ffd3e1 -->
    <style id="style">
      body {
        margin: 0px;
      }
      .imagecell > div:nth-child(2) > div:nth-child(2) {
        display: block;
        text-align: left;
      }
      div.mint-cell-wrapper {
        padding: 0px;
      }
      div.mint-cell-wrapper > div.mint-cell-value > input {
        background-color: #eee;
      }
      .comment {
        -webkit-filter: invert(.75);
                filter: invert(.75);
      }
      .headericon {
        -webkit-filter: invert(.75);
                filter: invert(.75);
      }
      .startbuttons {
        margin: 15px;
      }
      .mint-header {
        background-color: #222831;
      }
      #app {
        margin:0;
      }
      .mint-button--primary {
        background-color: #222831;
      }
      .mint-button--normal {
        background-color: #32e0c4;
      }
      .mint-button--default {
        background-color: #32e0c4;
      }
      .is-hidden {
        display: none;
      }
      .file-upload .input-wrapper {
        background-color: gray;
      }
      .img {
        width:100%;
        height:auto;
      }
      .contact {
        list-style:none;
        text-align:right;
        margin-top:30px;
      }
      .contacts {
        margin-top:15px;
      }
      .addcontact {
        padding: 10px;
        width: 85%;
      }
      .fieldlist div.mint-cell-wrapper > div.mint-cell-value > input {
        background-color: #fff;
      }
      .caption {
        margin-left: 20px;
      }
      .cant-click{
        pointer-events: none;
      }
      .oimg {
          position:relative;
          width:100%;
          height:auto;
          overflow:hidden;
      }
      .outer {
          position:relative;
          width:100%;
          height:auto;
          overflow:hidden;
      }
      .overlay {
          display: none;
      }
      .text {
          position: absolute;
          top: 50%;
          left: 50%;
          transform:translate(-50%, -50%);
          color:white;
      }
      .imagecell {
        position:relative;
        overflow:hidden;
        padding:0;
        margin:0;
      }
      .options {
        padding-right:20px;
      }
      .vidframe {
        margin:30px;
      }
      .groupimg {
        height:auto;
        padding:30px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        width: 50%;
      }
      .hosted-field {
        height: 50px;
        box-sizing: border-box;
        width: 100%;
        padding: 12px;
        display: inline-block;
        box-shadow: none;
        font-weight: 500;
        font-size: 14px;
        border-radius: $radius-default;
        border: 1px solid #dddddd;
        line-height: 20px;
        background: #fcfcfc;
        margin-bottom: 12px;
        background: linear-gradient(to right, white 50%, #fcfcfc 50%);
        background-size: 200% 100%;
        background-position: right bottom;
        transition: all 300ms ease-in-out;
      }
      .hosted-fields--label {
        font-family: courier, monospace;
        text-transform: uppercase;
        font-size: 14px;
        display: block;
        margin-bottom: 6px;
      }
      .button-container {
        display: block;
        text-align: center;
      }
      .braintree-hosted-fields-focused {
        border: 1px solid #64d18a;
        border-radius: $radius-default;
        background-position: left bottom;
      }
      .braintree-hosted-fields-invalid {
        border: 1px solid #ed574a;
      }
      .braintree-hosted-fields-valid {
      }
      #cardForm {
        max-width: 50.75em;
        margin: 0 auto;
        padding: 1.875em;
      }
      .dropbox {
        outline: 0;
        outline-offset: -10px;
        background: #ffd3e1;
        color: dimgray;
        padding: 10px 10px;
        position: relative;
        cursor: pointer;
        margin-top: 10px;
      }
      @media only screen and (min-width: 1025px) {
        .dropbox {
          width:700px;
        }
      }
      .input-file {
        opacity: 0;
        width: 100%;
        position: absolute;
        cursor: pointer;
      }
      .dropbox:hover {
        background: #AEA;
      }
      .img-thumbnail {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
        width: 150px;
      }
      .list-unstyled {
        list-style:none;
      }
      .uploadlabel {
        font-size: 1.4em;
      }
      #savepostbutton {
        margin-top: 10px;
        margin-bottom: 50px;
      }
      .bottom-button {
        position: fixed;
        bottom: 0;
        height: 75px;
        left: 0;
      }
      .buttonset {
        margin-top: 10px;
      }
      .help_header {
        margin:10px;
      }
      .help_para {
        margin:10px;
        text-align:left;
      }
      .help_popup {
        height:90%;
        width:90%;
        overflow-y: scroll;
      }
      .gettingstarted {
        margin:20px;
        text-align:left;
      }
      .templtext {
        background-color:#ccc;
      }
      .notifswitch {
        margin-right:15px;
      }
      .freqrange {
        margin-top:14px;
        margin-left:10px;
        margin-right:10px;
        margin-bottom:4px;
      }
      @media only screen and (min-width: 1025px) {
        body {
          width: 700px;
          margin: 0px auto;
        }
        .mint-tabbar {
          width: 700px;
          margin: 0px auto;
        }
      }
      .joinnotif {
        margin-bottom:20px;
      }
      .joinbutton {
        margin-bottom:100px;
      }
      .joinswitches {
        padding-bottom:14px;
      }
      .underpic {
        margin-top:10px;
      }
      .loginlink {
        margin:30px
      }
      .grimg {
        position:relative;
        max-width:130px;
        max-height:130px;
        height:auto;
        overflow:hidden;
        margin:20px;
      }
      .feedwrap {
        padding-bottom:100px;
      }
      .public_bio {
        margin:10px;
      }
      .public_img {
        margin-top:15px;
      }
      .addphotostab {
        padding-bottom: 50px;
      }
      .choosegroups {
        padding-top: 10px;
      }
      .secondtool {
        padding-right:15px;
      }
      .starttabscontent {
        padding-bottom:50px;
      }
      .firstHelp {
        text-align:left;
      }
      .startVid {
        width: 300px;
        height: auto;
        text-align: center;
      }
      .mailto {
        text-align: center;
      }
      .intro {
        max-width: 250px;
        max-height: 250px;
        height: auto;
      }
      .intro_tall {
        max-width: 250px;
        max-height: 450px;
        height: auto;
      }
      .introright {
      }
      .introleft {
      }
      .introblock {
        margin-bottom:50px;
      }
      .introcopy {
      }
      .signupbox {
      }
      .rplycopy {
        margin: 20px;
      }
      .codeinput {
        margin-right: 10px;
      }
      .vidcaption {
        margin-top:10px;
      }
    </style>

    <script id="client">

      const STATUS_INITIAL = 0, STATUS_SAVING = 1, STATUS_SUCCESS = 2, STATUS_FAILED = 3;

      const freeTrial = {
        data() {
          return {
            spinnerHidden : true,
            email: '',
            emailstatus: '',
            sent : false,
            phone : '',
            inputhidden: true,
            signuphidden: true,
            inputnamehidden: false,
            code: '',
            name:'',
            loginHidden: false,
            registerHidden: false,
            sentcode: '',
            selected: 'tab1'
          }
        },
        created() {
        },
        methods: {
          doCode() {
            this.spinnerHidden = false
            Vue.http.post( 'freeTrialStart', {
              code : this.code,
              email : this.email,
              phone : this.phone,
              name: this.name
            }).then( ( response ) => {
              if (response.body[0] == 'OK') {
                window.location.href = '/'
              } else {
                alert('Sorry, the code did not match')
                this.spinnerHidden = true
              }
            })
          },
          validateEmail(email) {
            var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(email)
          },
          myLogin(){
            if (this.email.indexOf('@') !== -1) {
              var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if (re.test(String(this.email).toLowerCase())) {
                this.emailstatus = 'success'
                Vue.http.post( 'freeTrialLogin', {
                  email : this.email,
                  phone : this.phone,
                  name: this.name
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  this.sent = true
                  this.inputhidden = false
                  this.sentcode = 'A code was just sent to your email address'
                  this.loginHidden = true
                })
              } else {
                this.emailstatus = 'error'
              }
            } else {
              if (this.email.match(/\d/g).length===10) {
                this.emailstatus = 'success'
                this.phone = this.email
                this.email = ''
                Vue.http.post( 'freeTrialLogin', {
                  email : this.email,
                  phone : this.phone
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  this.inputhidden = false
                  this.sent = true
                  this.sentcode = 'A code was just sent to your phone'
                  this.loginHidden = true
                 /* MintUI.Toast({
                    message: 'Check your text messages for a link!',
                    iconClass: 'icon icon-success',
                    duration: 10000
                   })*/
                })
              } else {
                this.emailstatus = 'error'
              }
            }
          },
          doLogin(){
            this.loginHidden = false
            this.registerHidden = true
          },
          doRegister(){
            this.loginHidden = true
            this.registerHidden = false
          },
          doTrial(){
            if (this.email.indexOf('@') !== -1) {
              var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if (re.test(String(this.email).toLowerCase())) {
                this.emailstatus = 'success'
                this.inputnamehidden = true
                Vue.http.post( 'freeTrial', {
                  email : this.email,
                  phone : this.phone,
                  name: this.name
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    this.inputnamehidden = false
                    this.emailstatus = 'error'
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  this.sentcode = 'A code was just sent to your email address'
                  this.registerHidden = true
                  this.sent = true
                  this.signuphidden = false
                })
              } else {
                this.emailstatus = 'error'
              }
            } else {
              if (this.email.match(/\d/g).length===10) {
                this.inputnamehidden = true
                this.emailstatus = 'success'
                this.phone = this.email
                this.email = ''
                Vue.http.post( 'freeTrial', {
                  email : this.email,
                  phone : this.phone
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    this.emailstatus = 'error'
                    this.inputnamehidden = false
                    return
                  }
                  this.sentcode = 'A code was just sent to your phone'
                  this.registerHidden = true
                  this.signuphidden = false
                  this.sent = true
                 /* MintUI.Toast({
                    message: 'Check your text messages for a link!',
                    iconClass: 'icon icon-success',
                    duration: 10000
                   })*/
                })
              } else {
                this.emailstatus = 'error'
              }
            }
          },
          goLogin() {
            this.selected = "tab2"
          }
        },
        template: `
          <div class="feedwrap">
            <mt-tabbar fixed="true" v-model="selected">
              <mt-tab-item id="tab1">
                <img slot="icon" src="/file/users.svg" />
                Sign Up
              </mt-tab-item>
              <mt-tab-item id="tab2">
                <img slot="icon" src="/file/home.svg" />
                Log In
              </mt-tab-item>
            </mt-tabbar>
            <div class="introblock">
        <h1>Rp.ly</h1>
        <h5 class="rplycopy">
        Rp.ly is a decentralized photo sharing platform that connects photographers and users directly, Rp.ly is free from algorithm recommended accounts or for-profit ads, giving content creators a market place to use as they see fit.
        </h5>
                <div class="introblock">
                  <img class="intro introleft" src="file/rply1.jpg" />
                  <p class="introright introcopy">Upload and get a link</p>
               </div>
               <div class="introblock">
                <img class="intro introleft" src="file/rply3.jpg" />
                  <p class="introright introcopy">Paste link as text message</p>
               </div>
               <div class="introblock">
                <img class="intro_tall introleft" src="file/rply5.jpg" />
                  <p class="introright introcopy">Contact info required to see photos</p>
               </div>
               <div class="introblock">
                <img class="intro introright" src="file/rply2.jpg" />
                  <p class="introleft introcopy">Paste link to social networks</p>
               </div>
               <div class="introblock">
                <img class="intro_tall introright" src="file/rply4.jpg" />
                  <p class="introleft introcopy">Public gallery with link to contact-info-required gallery</p>
               </div>
            </div>
            <mt-tab-container v-model="selected" class="introblock signupbox">
              <mt-tab-container-item id="tab1">
                <mt-header title=""></mt-header>
                <h4>It's easy to start! You will receive an e-mail or text message with a login code:</h4>
                <mt-field v-bind:class="{'is-hidden':inputnamehidden}" placeholder="Your name..." v-model="name"></mt-field>
                <mt-field v-bind:class="{'is-hidden':registerHidden}" placeholder="Email or Phone Number..." type="email" :state="emailstatus" v-model="email"></mt-field>
                <mt-button v-bind:class="{'is-hidden':registerHidden}" v-on:click="doTrial()" size="large">Sign Up</mt-button>
                <mt-cell v-bind:class="{'is-hidden':signuphidden}" class="codeinput">{{sentcode}}</mt-cell>
                <mt-field v-bind:class="{'is-hidden':signuphidden}" class="codeinput" type="number" label="Code:" placeholder="***" v-model="code"></mt-field>
                <mt-button v-bind:class="{'is-hidden':signuphidden}" v-on:click="doCode()" size="large">Submit Code</mt-button>
                <div class="loginlink"><a href="javascript:void(0)" @click="goLogin()">Already Registered?</a></div>
                <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
              </mt-tab-container-item>
              <mt-tab-container-item id="tab2">
                <mt-header title=""></mt-header>
                <h4>Welcome! Type an e-mail address or phone number to receive a login code:</h4>
                <mt-field v-bind:class="{'is-hidden':loginHidden}" placeholder="Email or Phone Number..." type="email" :state="emailstatus" v-model="email"></mt-field>
                <mt-button v-bind:class="{'is-hidden':loginHidden}" v-on:click="myLogin()" size="large">Log In</mt-button>
                <mt-cell v-bind:class="{'is-hidden':inputhidden}" class="codeinput">{{sentcode}}</mt-cell>
                <mt-field v-bind:class="{'is-hidden':inputhidden}" class="codeinput" type="number" label="Code:" placeholder="***" v-model="code"></mt-field>
                <mt-button v-bind:class="{'is-hidden':inputhidden}" v-on:click="doCode()" size="large">Submit Code</mt-button>
                <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
              </mt-tab-container-item>
            </mt-tab-container>
          </div>`
      }
      const connect = {
        data() {
          return {
            code:'',
            spinnerHidden:false,
            sentcode: ''
          }
        },
        props: {},
        created() {
          if (!(window.location.href.match(/\/g\//g) === null)) {
            window.location.href = 'https://' + window.location.hostname + '/#/connect/' + this.$route.params.code
            return
          }
          this.spinnerHidden = false
          Vue.http.post( 'doConnect', {
            code:this.$route.params.code
          }).then( ( response ) => {
            if (response.body[0] == 'OK') {
              window.location.href = '/'
            } else {
              this.sentcode = 'A code was just sent to your ' + response.body[0]
            }
            this.spinnerHidden = true
          })
        },
        methods: {
          doCode() {
            this.spinnerHidden = false
            Vue.http.post( 'doCode', {
              code:this.code,
              connect:this.$route.params.code
            }).then( ( response ) => {
              if (response.body[0] == 'OK') {
                window.location.href = '/'
              } else {
                alert('Sorry, the code did not match')
              }
              this.spinnerHidden = true
            })
          }
        },
        template: `
          <div>
            <mt-header title="">
            </mt-header>
            <mt-cell>{{sentcode}}</mt-cell>
            <mt-field type="number" class="codeinput" label="Code:" placeholder="***" v-model="code"></mt-field>
            <mt-button v-on:click="doCode()" size="large">Submit Code</mt-button>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
          </div>`
      }
      const ShowGroupPage = {
        data() {
          return {
            spinnerHidden: true,
            isInstagram: false,
            publicName: '',
            publicBio: '',
            publicImage: '',
            publicLink: '',
            publicGroups: [],
            grp:'',
            image:'',
            name:'',
            items:[],
            moreHidden: true
          }
        },
        created() {
          this.grp = this.$route.params.grp
          var ua = navigator.userAgent || navigator.vendor || window.opera
          this.isInstagram = (ua.indexOf('Instagram') > -1) ? true : false
          this.spinnerHidden = false
          Vue.http.post( 'joinGroup', {
            grp:this.$route.params.grp
          }).then( ( response ) => {
            var publicData = JSON.parse(response.body[6])
            if ("undefined" !== typeof publicData['publicName']) {
              this.publicName = publicData['publicName']
              this.publicBio = publicData['publicBio'].replace("\n","<br>")
              this.publicLink = publicData['publicLink']
              this.publicImage = publicData['publicImage']
              this.publicGroups = publicData['publicGroups']
              this.image = response.body[2]
              this.name = response.body[1]
               //this.publicGroups.unshift({grp:this.$route.params.grp,image:,name:})
              for(grp in this.publicGroups) {
                //alert(this.publicGroups[grp].image)
              }
              Vue.http.get( 'getPosts' + '?grp=' + this.$route.params.grp).then( ( response ) => {
                if ( !!response.body ) {
                  if (this.cursor > 0) {
                    if (response.body[0].length < 10) {
                      this.moreHidden = true
                    }
                    for (var j = 0; j < response.body[0].length; j++) {
                      this.items.push(response.body[0][j])
                    }
                  } else {
                    this.items = response.body[0]
                    if (this.items.length > 9) {
                      this.moreHidden = false
                    }
                  }
                }
                this.spinnerHidden = true
              })
            } else {
              router.push( '/showgroup/' + this.$route.params.grp )
            }
          })
        },
        methods: {
          imageLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=image&name=' + item.image
            }
          },
          videoLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=video&name=' + item.video
            }
          }
        },
        template: `
          <div>
            <mt-header title="">
              <a href="/" slot="left">
                <img class="headericon" slot="icon" src="file/home.svg" />
              </a>
              <a v-on:click="showHelp()" slot="right">
                <img class="headericon" slot="icon" src="file/help-circle.svg" />
              </a>
            </mt-header>
            <img class="groupimg" :src="'grpFile?field=publicImage&name=' + publicImage" />
            <h3 v-text="publicName"></h3>
            <p><a :href="publicLink" v-text="publicLink"></a></p>
            <h5 class="public_bio" v-html="publicBio"></h5>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <!--<mt-cell :title="name" is-link :to="'/pubgroup/' + grp">
              <img class="grimg" :src="image" />
            </mt-cell>-->
            <mt-cell class="imagecell public_img" v-for="(item, idx) in items" :title="item.name">
              <p class="caption" v-text="item.title" v-bind:class="{'is-hidden':item.textHidden}"></p>
              <div class="outer">
                <img class="oimg" :src="imageLink(item)" v-if="item.allowDownload" />
                <img @contextmenu.prevent="doContextMenu" class="oimg cant-click" :src="imageLink(item)" v-else />
                <figcaption class="caption underpic" v-text="item.title"></figcaption>
                <audio-player :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              </div>
              <vue-plyr v-if="item.isVideo">
                <video :poster="item.image" :src="videoLink(item)" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
                <figcaption class="caption" v-text="item.title"></figcaption>
              </vue-plyr>
              <audio-player v-if="item.imageHidden" :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
            </mt-cell>
            <mt-cell v-for="(item, idx) in publicGroups" :title="item.name" is-link :to="'/showgroup/' + item.grp">
              <img class="grimg" :src="item.image" />
            </mt-cell>
          </div>`
      }
      const PublicGroupPage = {
        data() {
          return {
            spinnerHidden: true,
            isInstagram: false,
            groupPic: '',
            items: []
          }
        },
        created() {
          var ua = navigator.userAgent || navigator.vendor || window.opera
          this.isInstagram = (ua.indexOf('Instagram') > -1) ? true : false
          this.spinnerHidden = false
          Vue.http.post( 'joinGroup', {
            grp:this.$route.params.grp
          }).then( ( response ) => {
            this.groupPic = response.body[2]
            var publicData = JSON.parse(response.body[6])
            if ("undefined" !== typeof publicData['publicName']) {
              Vue.http.get( 'getPosts' + '?grp=' + this.$route.params.grp).then( ( response ) => {
                if ( !!response.body ) {
                  if (this.cursor > 0) {
                    if (response.body[0].length < 10) {
                      this.moreHidden = true
                    }
                    for (var j = 0; j < response.body[0].length; j++) {
                      this.items.push(response.body[0][j])
                    }
                  } else {
                    this.items = response.body[0]
                    if (this.items.length > 9) {
                      this.moreHidden = false
                    }
                  }
                  console.log(this.items)
                }
                this.spinnerHidden = true
              })
              this.spinnerHidden = true
            } else {
            }
          })
        },
        methods: {
          imageLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=image&name=' + item.image
            }
          },
          videoLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=video&name=' + item.video
            }
          }
        },
        template: `
          <div>
            <mt-header title="">
            </mt-header>
            <img class="groupimg" :src="'grpFile?field=image&name=' + groupPic" />
            <mt-cell class="imagecell" v-for="(item, idx) in items" :title="item.name">
              <p class="caption">
                <span v-text="item.author"></span>
                <img class="headericon" src="file/chevron-right.svg" />
                <span v-text="item.to"></span>
              </p>
              <p class="caption" v-text="item.title" v-bind:class="{'is-hidden':item.textHidden}"></p>
              <div class="outer">
                <img class="oimg" :src="imageLink(item)" v-if="item.allowDownload" />
                <img @contextmenu.prevent="doContextMenu" class="oimg cant-click" :src="imageLink(item)" v-else />
                <figcaption class="caption underpic" v-text="item.title"></figcaption>
                <audio-player :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              </div>
              <vue-plyr v-if="item.isVideo">
                <video :poster="item.image" :src="videoLink(item)" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
                <figcaption class="caption" v-text="item.title"></figcaption>
              </vue-plyr>
              <audio-player v-if="item.imageHidden" :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
            </mt-cell>
          </div>`
      }
      const GroupPage = {
        data() {
          return {
            grp:'',
            spinnerHidden: false,
            inviteText: ' invited you to join ',
            submitText: '',
            validName: '',
            validContact: '',
            newName: '',
            newContact:'',
            newEmail: '',
            newPhone: '',
            imgHidden: true,
            groupPic: '',
            signupHidden: false,
            ownname: '',
            grpname: '',
            emailstatus: '',
            docodehidden: true,
            code: '',
            signupBtnHidden: false,
            isInstagram: false,
            freq:2,
            interval:'Day',
            helpVisible: false,
            publicName: '',
            publicBio: '',
            publicImage: '',
            publicLink: '',
            publicGroups: [],
            notMember: true,
            memberText: 'You are already a member of ',
            linked: false
          }
        },
        beforeRouteEnter (to, from, next) {
          if (from.path !== '/') {
            next(vm => {
              vm.linked = true
            })
          } else {
            next()
          }
        },
        props: {},
        created() {
          var ua = navigator.userAgent || navigator.vendor || window.opera
          this.isInstagram = (ua.indexOf('Instagram') > -1) ? true : false
          this.spinnerHidden = false
          Vue.http.post( 'joinGroup', {
            grp:this.$route.params.grp
          }).then( ( response ) => {
            if (response.body[3] == 'AUTHED') {
              this.signupHidden = true
              this.signupBtnHidden = false
              if (response.body[5] == 'MEMBER') {
                //window.location.href = '/'
                this.notMember = false
              }
            } else {
              this.signupHidden = false
              this.signupBtnHidden = false
            }
            this.ownname = response.body[0]
            this.grpname = response.body[1]
            this.inviteText = response.body[0] + this.inviteText + response.body[1]
            this.memberText = this.memberText + response.body[1]
            this.submitText = 'Join ' + response.body[0] + "'s Gallery"
            this.groupPic = response.body[2]
            this.imgHidden = false
            this.spinnerHidden = true
            var publicData = JSON.parse(response.body[6])
            if ("undefined" !== typeof publicData['publicName']) {
              this.publicName = publicData['publicName']
              this.publicBio = publicData['publicBio']
              this.publicLink = publicData['publicLink']
              this.publicImage = publicData['publicImage']
              this.publicGroups = publicData['publicGroups']
            }
          })
        },
        methods: {
          doCode() {
            this.spinnerHidden = false
            Vue.http.post( 'freeTrialStart', {
              code : this.code,
              grp : this.$route.params.grp,
              name : this.newName,
              email : this.newEmail,
              phone : this.newPhone
            }).then( ( response ) => {
              if (response.body[0] == 'OK') {
                this.spinnerHidden = false
                Vue.http.post( 'setGroupNotif', {
                  grp : this.$route.params.grp,
                  freq : this.freq,
                  interval : this.interval
                }).then( ( response ) => {
                  window.location.href = '/'
                })
              } else {
                alert('Sorry, the code did not match')
              }
            })
          },
          doJoin() {
            if (this.newContact.indexOf('@') !== -1) {
              var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if (re.test(String(this.newContact).toLowerCase())) {
                this.validContact = "success"
                this.newEmail = this.newContact
              }
            } else {
              if (this.newContact.substring(0, 2) == '+1') {
                this.newContact = this.newContact.substring(2)
              }
              if (!(this.newContact.match(/\d/g) === null)) {
                if (this.newContact.match(/\d/g).length===10) {
                  this.validContact = "success"
                  this.newPhone = this.newContact
                }
              }
            }
            if (!this.signupHidden) {
              if (this.validContact !== "success"){
                MintUI.Toast({
                  message: 'Please enter a valid phone number or email address',
                  iconClass: 'icon icon-error',
                  duration: 2000
                })
                return
              }
            }
            if (!this.signupHidden) {
              if (this.newContact.length == 0) {
                MintUI.Toast({
                  message: 'Please enter a phone number or email address',
                  iconClass: 'icon icon-error',
                  duration: 2000
                })
                return
              }
            }
            if (!this.signupHidden) {
              if (this.newName.length == 0) {
                MintUI.Toast({
                  message: 'Please enter your name',
                  iconClass: 'icon icon-error',
                  duration: 2000
                })
                return
              }
            }
            this.spinnerHidden = false
            this.inviteText = ''
            this.docodehidden = false
            if (this.signupHidden) {
              Vue.http.post( 'doJoin', {
                grp : this.$route.params.grp,
                name : this.newName,
                email : this.newEmail,
                phone : this.newPhone
              }).then( ( response ) => {
                if (response.body[0] == 'error') {
                  MintUI.Toast({
                    message: 'Error',
                    iconClass: 'icon icon-error',
                    duration: 2000
                  })
                  return
                }
                this.spinnerHidden = false
                Vue.http.post( 'setGroupNotif', {
                  grp : this.$route.params.grp,
                  freq : this.freq,
                  interval : this.interval
                }).then( ( response ) => {
                  MintUI.Toast({
                    message: 'You have been added to the gallery',
                    iconClass: 'icon icon-success',
                    duration: 2000
                  })
                  this.spinnerHidden = true
                  router.push('/')
                })
              })
            } else if (this.newContact.indexOf('@') !== -1) {
              var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if (re.test(String(this.newEmail).toLowerCase())) {
                Vue.http.post( 'doJoin', {
                  grp : this.$route.params.grp,
                  name : this.newName,
                  email : this.newEmail,
                  phone : this.newPhone
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  this.inviteText = 'A code was just sent to your email address'
                  this.spinnerHidden = true
                  this.signupHidden = true
                  this.signupBtnHidden = true
                })
              } else {
                this.emailstatus = 'error'
              }
            } else {
              if (this.newContact.match(/\d/g).length===10) {
                Vue.http.post( 'doJoin', {
                  grp : this.$route.params.grp,
                  name : this.newName,
                  email : this.newEmail,
                  phone : this.newPhone
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  this.inviteText = 'A code was just sent to your phone'
                  this.spinnerHidden = true
                  this.signupHidden = true
                  this.signupBtnHidden = true
                })
              } else {
                this.emailstatus = 'error'
              }
            }
          },
          checkConName() {
            this.validName = "success"
          },
          checkContact() {
            this.newPhone = ''
            this.newEmail = ''
            this.validContact = ''
            if (this.newContact.indexOf('@') !== -1) {
              var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if (re.test(String(this.newContact).toLowerCase())) {
                this.validContact = "success"
                this.newEmail = this.newContact
              } else {
                this.validContact = "error"
              }
            } else {
              if (this.newContact.substring(0, 2) == '+1') {
                this.newContact = this.newContact.substring(2)
              }
              if (!(this.newContact.match(/\d/g) === null))
                if (this.newContact.match(/\d/g).length===10) {
                  this.validContact = "success"
                  this.newPhone = this.newContact
                } else {
                  this.validContact = "error"
                }
            }
          },
          showHelp() {
            this.helpVisible = true
          },
          closeHelp(){
            this.helpVisible = false
          },
          doContinue(){
            window.location.href = '/'
          }
        },
        template: `
          <div>
            <mt-header title="">
              <a v-if="linked" slot="left">
                <mt-button slot="left" @click="$router.go(-1)" icon="back">back</mt-button>
              </a>
              <a v-else href="/" slot="left">
                <img class="headericon" slot="icon" src="file/home.svg" />
              </a>
              <a v-on:click="showHelp()" slot="right">
                <img class="headericon" slot="icon" src="file/help-circle.svg" />
              </a>
            </mt-header>
            <img v-bind:class="{'is-hidden':imgHidden}" class="groupimg" :src="groupPic" />
            <mt-cell v-if="notMember" :title="inviteText"></mt-cell>
            <div v-if="isInstagram">
              <h3>You're almost there!</h3>
              <p>It looks like you're using Instagram's built-in Web browser.</p>
              <p>Please click "..." at top-right and then click "Open in Safari" (Or use any mobile web browser)</p>
            </div>
            <div v-else>
              <div v-if="notMember">
                <mt-field v-bind:class="{'is-hidden':signupHidden}" :state="validName" placeholder="Name" @keyup.native="checkConName" v-model="newName"></mt-field>
                <mt-field v-bind:class="{'is-hidden':signupHidden}" :state="validContact" @keyup.native="checkContact" placeholder="Email or Phone..." v-model="newContact" type="email"></mt-field>
                <div v-bind:class="{'is-hidden':signupBtnHidden}" class="joinnotif">
                  <h5 v-text="'Notifications Limit: ' + freq + ' per ' + interval"></h5>
                  <mt-radio
                    v-model="interval"
                    :options="['Day', 'Week']">
                  </mt-radio>
                  <mt-range class="freqrange"
                    v-model="freq"
                    :min="1"
                    :max="10"
                    :step="1"
                    :bar-height="5">
                    <div slot="start">1</div>
                    <div slot="end">10</div>
                  </mt-range>
                </div>
                <mt-button class="joinbutton" v-bind:class="{'is-hidden':signupBtnHidden}" v-on:click="doJoin()" size="large">{{submitText}}</mt-button>
                <mt-field v-bind:class="{'is-hidden':docodehidden}" class="codeinput" type="number" label="Code:" placeholder="***" v-model="code"></mt-field>
                <mt-button v-bind:class="{'is-hidden':docodehidden}" v-on:click="doCode()" size="large">Submit Code</mt-button>
                <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
              </div>
              <div v-if="!notMember">
                <mt-cell :title="memberText"></mt-cell>
                <mt-button v-on:click="doContinue()" size="large">Continue</mt-button>
              </div>
            </div>
            <mt-popup class="help_popup" v-model="helpVisible" position="middle">
              <mt-header>
                <a v-on:click="closeHelp()" slot="left">
                  <mt-button>X</mt-button>
                </a>
              </mt-header>
              <h4 class="help_header">What is this?</h4>
              <p class="help_para">RP.LY is a new kind of digital photo gallery that helps photographers offer an expanded set of images.</p>
            </mt-popup>
          </div>`
      }
      const listPosts = {
        data() {
          return {
            spinnerHidden : true
          }
        },
        props: { items : Array, editHidden: Boolean, cangrps : Array, moreHidden: Boolean, doSponsor: Object },
        created() {
          if (this.items.length == 0) {
            this.moreHidden = true
          }
        },
        methods: {
          openImage(idx){
            if (this.items[idx].isOwner) {
              //router.push( '/showPosts/' + idx )
            }
          },
          showLink(){
            this.$emit('on-show-menu')
          },
          showHelp(){
            this.$emit('on-show-help')
          },
          delPosts( id, idx ){
            this.spinnerHidden = false
            Vue.http.post( 'delPosts', {
              id:id
            }).then( ( response ) => {
              this.items.splice( idx, 1 )
              this.spinnerHidden = true
            })
          },
          imageLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=image&name=' + item.image
            }
          },
          videoLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=video&name=' + item.video
            }
          },
          doContextMenu(e){
            e.preventDefault()
          },
          showMore(){
            this.spinnerHidden = false
            this.moreHidden = true
            this.$emit('load-more-items')
            this.spinnerHidden = true
          },
          showSponsor(grp) {
            this.$emit('update:doSponsor', grp)
            this.$emit('show-sponsor')
          },
          addComment(idx) {
            this.items[idx].showCommentField = true
          },
          saveComment(post,idx) {
            this.spinnerHidden = false
            Vue.http.post( 'addPosts', {
              recips: post.groups,
              title: post.comment,
              inreplyto: post.id,
              expirehours: 0,
              speedup: ''
            }).then( ( response ) => {
              this.items[idx].comment = ''
              this.spinnerHidden = true
              this.items[idx].showCommentField = false
              MintUI.Toast({
                message: 'Comment Saved',
                iconClass: 'icon icon-success',
                duration: 1000
              })
            })
          },
          openGall(toid){
            router.push( '/showGroupPosts/' + toid )
          },
          newGall(){
            router.push('/groups/new')
          }
        },
        template: `
          <div class="feedwrap">
            <mt-header title="">
              <a v-on:click="showHelp()" slot="left">
                <img class="headericon" slot="icon" src="file/help-circle.svg" />
              </a>
              <a v-on:click="newGall()" slot="right">
                <img class="headericon secondtool" slot="icon" src="file/list.svg" />
              </a>
              <a v-on:click="showLink()" slot="right">
                <img class="headericon" slot="icon" src="file/settings.svg" />
              </a>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell class="imagecell" v-for="(item, idx) in items" :title="item.name">
              <p class="caption">
                <span v-text="item.author"></span>
                <img v-if="!item.isHtml" class="headericon" src="file/chevron-right.svg" />
                <span v-text="item.to"></span>
                <mt-button v-if="!item.isHtml" icon="more" v-on:click="openGall(item.toid)"></mt-button>
              </p>
              <p v-if="item.isHtml" class="caption" v-on:click="openImage(idx)" v-html="item.title" v-bind:class="{'is-hidden':item.textHidden}"></p>
              <p v-else class="caption" v-on:click="openImage(idx)" v-text="item.title" v-bind:class="{'is-hidden':item.textHidden}"></p>
              <div class="outer" v-on:click="openImage(idx)" v-bind:class="{'is-hidden':item.imageHidden}">
                <img class="oimg" :src="imageLink(item)" v-if="item.allowDownload" />
                <img @contextmenu.prevent="doContextMenu" class="oimg cant-click" :src="imageLink(item)" v-else />
                <figcaption class="caption underpic" v-text="item.title"></figcaption>
                <audio-player :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              </div>
              <vue-plyr v-if="item.isVideo">
                <video :poster="item.image" :src="videoLink(item)" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
                <figcaption class="caption vidcaption" v-text="item.title"></figcaption>
              </vue-plyr>
              <audio-player v-if="item.imageHidden" :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              <p class="caption" v-for="(comm, cidx) in item.comments" v-text="comm.author + ': ' + comm.title"></p>
              <p v-if="!item.isHtml" v-bind:class="{'is-hidden':item.showCommentField}" class="caption" v-on:click="addComment(idx)"><img class="comment" slot="icon" src="file/message-square.svg" /></p>
              <mt-field v-bind:class="{'is-hidden':!item.showCommentField}" placeholder="Comment..." v-model="item.comment"></mt-field>
              <mt-button v-bind:class="{'is-hidden':!item.showCommentField}" size="large" v-on:click="saveComment(item,idx)">Save Comment</mt-button>
            </mt-cell>
            <mt-cell v-for="grp in cangrps" :title="'Would you like to see every post by ' + grp.guser + ' in ' + grp.gname + '?'"><mt-button type="primary" size="small" v-on:click="showSponsor(grp)">Become a Sponsor</mt-button></mt-cell>
          </div>`
      }
      const showGroupPosts = {
        data() {
          return {
            spinnerHidden : true,
            idx: this.$route.params.idx,
            moreHidden: true,
            cursor: 0,
            prevcursor: 0,
            cogHidden: true,
            groups: []
          }
        },
        props: { posts : Array, selected: String, postto: Array },
        created() {
          this.posts = []
          this.loadPosts()
        },
        methods: {
          loadPosts(){
            if (this.cursor > 0 && (this.prevcursor === this.cursor)) {
              
            } else {
              this.spinnerHidden = false
              this.prevcursor = this.cursor
              Vue.http.get( 'getPosts' + '?grpid=' + this.$route.params.grpid + '&cursor=' + this.cursor.toString()).then( ( response ) => {
                if ( !!response.body ) {
                  if (this.cursor > 0) {
                    if (response.body[0].length < 10) {
                      this.moreHidden = true
                    }
                    for (var j = 0; j < response.body[0].length; j++) {
                      this.posts.push(response.body[0][j])
                    }
                    this.moreHidden = false
                  } else {
                    this.posts = response.body[0]
                    this.groups = response.body[1]
                    if (this.posts.length > 9) {
                      this.moreHidden = false
                    }

                    Vue.http.get( 'getGroups').then( ( response ) => {
                      if ( !!response.body ) {
                        this.groups = response.body[0]
                        for (var i = 0; i < this.groups.length; i++) {
                          if (parseInt(this.groups[i].id) == parseInt(this.$route.params.grpid)) {
                            this.cogHidden = !this.groups[i].isOwner
                          }
                        }
                      }
                    })

                    //if (this.items[idx].isOwner) {
                      //router.push( '/showPosts/' + idx )
                      //}
                    
                  }
                }
                this.spinnerHidden = true
                this.$emit('update:posts', this.posts)
              })
            }
          },
          openImage(idx){
            if (this.posts[idx].isOwner) {
              router.push( '/showPosts/' + idx )
            }
          },
          imageLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=image&name=' + item.image
            }
          },
          videoLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=video&name=' + item.video
            }
          },
          showMore(){
            this.cursor = this.posts.length
            this.loadPosts()
          },
          addComment(idx) {
            this.posts[idx].showCommentField = true
          },
          saveComment(post,idx) {
            this.spinnerHidden = false
            Vue.http.post( 'addPosts', {
              recips: post.groups,
              title: post.comment,
              inreplyto: post.id,
              expirehours: 0,
              speedup: ''
            }).then( ( response ) => {
              this.posts[idx].comment = ''
              this.spinnerHidden = true
              this.posts[idx].showCommentField = false
              MintUI.Toast({
                message: 'Comment Saved',
                iconClass: 'icon icon-success',
                duration: 1000
              })
            })
          },
          loadMore(){
            this.loading = true
            setTimeout(() => {
              this.cursor = this.posts.length
              this.loadPosts()
              this.loading = false
            }, 2500)
          },
          gallSett(){
            router.push('/groups/' + this.$route.params.grpid)
          },
          newGall(){
            router.push('/groups/new')
          },
          addToGallery(){
            for (var i = 0; i < this.groups.length; i++) {
              if (parseInt(this.groups[i].id) == parseInt(this.$route.params.grpid)) {
                this.$emit('update:postto', [this.groups[i].id])
              }
            }
            this.$emit('update:selected', 'tab3')
            router.push('/')
          }
        },
        template: `
          <div class="feedwrap">
            <mt-header title="">
              <mt-button slot="left" @click="$router.go(-1)" icon="back">back</mt-button>
              <a v-if="!cogHidden" v-on:click="gallSett()" slot="right">
                <img class="headericon" slot="icon" src="file/settings.svg" />
              </a>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>

            <mt-cell v-infinite-scroll="loadMore"
                infinite-scroll-disabled="loading"
                infinite-scroll-distance="0"
                class="imagecell"
                v-for="(item, idx) in posts"
                :title="item.name">
              <p class="caption" v-on:click="openImage(idx)" v-text="item.title" v-bind:class="{'is-hidden':item.textHidden}"></p>
              <div class="outer" v-on:click="openImage(idx)" v-bind:class="{'is-hidden':item.imageHidden}">
                <img class="oimg" :src="imageLink(item)" v-if="item.allowDownload" />
                <img @contextmenu.prevent="doContextMenu" class="oimg cant-click" :src="imageLink(item)" v-else />
                <figcaption class="caption underpic" v-text="item.title"></figcaption>
                <audio-player :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              </div>
              <vue-plyr v-if="item.isVideo">
                <video :poster="item.image" :src="videoLink(item)" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
                <figcaption class="caption" v-text="item.title"></figcaption>
              </vue-plyr>
              <audio-player v-if="item.imageHidden" :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              <p class="caption" v-for="(comm, cidx) in item.comments" v-text="comm.author + ': ' + comm.title"></p>
              <p v-bind:class="{'is-hidden':item.showCommentField}" class="caption" v-on:click="addComment(idx)"><img class="comment" slot="icon" src="file/message-square.svg" /></p>
              <mt-field v-bind:class="{'is-hidden':!item.showCommentField}" placeholder="Comment..." v-model="item.comment"></mt-field>
              <mt-button v-bind:class="{'is-hidden':!item.showCommentField}" size="large" v-on:click="saveComment(item,idx)">Save Comment</mt-button>
            </mt-cell>
            <mt-button v-if="!cogHidden" size="large" v-on:click="addToGallery()"><img slot="icon" src="/file/plus-circle.svg" /></mt-button>
          </div>`
      }
      const showPosts = {
        data() {
          return {
            spinnerHidden : true,
            idx: this.$route.params.idx,
            id : 0,
            title : '',
            image : '',
            sound : '',
            soundHidden : false,
            imageHidden : false
          }
        },
        props: { posts : Array },
        created() {
          if (this.posts.length == 0) {
            this.$emit('on-update-list')
            setTimeout( function (self) {
              self.setData()
            }, 2000, this)
          } else {
            this.setData()
          }
        },
        methods: {
          setData(){
            this.id = this.posts[ this.idx ].id
            this.title = this.posts[ this.idx ].title
            this.image = this.posts[ this.idx ].image
            this.sound = this.posts[ this.idx ].sound
            if (this.sound == '') {
              this.soundHidden = true
            }
            if (this.image == '') {
              this.imageHidden = true
            }
            this.$emit('on-tabs-hidden')
          },
          delPosts(){
            var showposts = this
            MintUI.MessageBox({
              title: 'Delete',
              message: 'Are you sure you want to delete this post?',
              showCancelButton: true,
              confirmButtonText: 'Confirm Delete',
              cancelButtonText: 'Cancel'
            }).then(action => {
              if (action === 'confirm') {
                showposts.spinnerHidden = false
                Vue.http.post( 'delPosts', {
                  id:showposts.id
                }).then( ( response ) => {
                  showposts.spinnerHidden = true
                  showposts.posts.splice( showposts.idx, 1 )
                  router.push('/')
                })
              }
            })

          },
          doContextMenu(e){
            e.preventDefault()
          }
        },
        template: `
          <div>
            <mt-header title="">
              <mt-button slot="left" @click="$router.go(-1)" icon="back">back</mt-button>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell  :title="title"></mt-cell>
            <mt-cell v-bind:class="{'is-hidden':imageHidden}">
              <div class="outer">
                <img @contextmenu.prevent="doContextMenu" class="oimg cant-click" :src="'myFile?field=image&name=' + image" />
                <div class="overlay">
                  <p class="text">&nbsp;</p>
                </div>
              </div>
            </mt-cell>
            <mt-cell v-bind:class="{'is-hidden':soundHidden}"><audio-player :src="'myFile?field=sound&name=' + sound" /></mt-cell>
            <mt-button size="large" v-on:click="delPosts()">Delete Photo</mt-button>

          </div>`
      }
      const modPosts = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            idx: this.$route.params.idx,
            id : 0,
            title : '',
            image : '',
            sound : ''
          }
        },
        props: { items : Array },
        created() {
          this.id = this.items[ this.idx ].id
          this.title = this.items[ this.idx ].title
          this.image = this.items[ this.idx ].image
          this.sound = this.items[ this.idx ].sound

          this.$emit('on-tabs-hidden')
        },
        methods: {
          modPosts(){
            this.spinnerHidden = false
            Vue.http.post( 'modPosts', {
              id : this.id,
              title : this.title
            }).then( ( response ) => {
              this.$emit('on-update-list')
              router.push( '/' )
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => {
              if ( !!response.body ) {
                this[field] = response.body
              }
            })
          }
        },
        template: `
          <div>
            <mt-header title="">
              <router-link :to="'/showPosts/' + idx" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-field label="Title:" placeholder="Title.." v-model="title"></mt-field>
            <mt-cell title=""><img class="img" :src="'myFile?staged=1&field=image&name=' + image" /></mt-cell>
            <file-upload btn-label="Image" @change="stagedUpload('image')" :url="uploadTo + '&field=image'"></file-upload>
            <mt-cell title="Sound:"><audio-player :src="'myFile?staged=1&field=sound&name=' + sound" /></mt-cell>
            <audio-recorder :upload-url="uploadTo + '&field=sound'"/>
            <mt-button v-on:click="modPosts()" size="large">Save</mt-button>
          </div>`
      }
      const Posts = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadMulti',
            selected : 'tab1',
            items : [],
            tabsHidden: false,
            groups: [],
            abilities:[],
            editHidden:true,
            groupsHidden:false,
            postto:[],
            comet:'',
            title : '',
            image : '',
            cgroups:[{id:1,user_id:1,name:'Admins',perms:[],members:[]},{id:2,user_id:1,name:'Group 2',perms:[],members:[]},{id:3,user_id:1,name:'Group 3',perms:[],members:[]}],
            contacts:[{id:1,user_id:1,name:'Me',email:'',phone:'',groups:[1,2,3]}],
            lastgroups : [],
            saveHidden: false,
            uploadHidden: false,
            imgHidden: true,
            linkVisible: false,
            feedsVisible: false,
            feedLink: '',
            addFeed: '',
            feeds: [],
            textHidden: true,
            audioHidden: false,
            showAddContact: false,
            validName: '',
            validContact: '',
            newName:'',
            newContact:'',
            newEmail:'',
            newPhone:'',
            doExpire: false,
            expireHours: '24',
            optionsBtnHidden: false,
            optionsHidden: true,
            sponsorVisible: false,
            subs: [],
            btAuth: '',
            plan: 'fans50',
            plans:[{label: '$3 twice-a-year',value: 'fans50'},{label: '$3 monthly',value: 'fans300'}],
            cangrps: [],
            sponsorGroup: '',
            sponsorGroupName: '',
            btLoaded:false,
            formHidden: true,
            btSpinnerHidden:false,
            subsVisible: false,
            subsHidden: true,
            settingsSpinnerHidden:true,
            uploadedFiles: [],
            uploadError: null,
            currentStatus: null,
            uploadFieldName: 'photos',
            speedup: '1.1',
            cursor: 0,
            moreHidden: true,
            doSponsor: {},
            noSubsTxt: 'No subscriptions',
            helpVisible: false,
            help1: false,
            help2: false,
            help3: false,
            help4: false,
            help5: false,
            help6: false,
            help7: false,
            help8: false,
            gettingStarted:false,
            template1: 'I\'m using RP.LY to share an expanded photo selection with those who join my gallery for (occasional) email or text message notifications. Click link in bio to join my new gallery.',
            template2: 'I\'m using RP.LY to share an expanded photo selection with those who join my gallery for (occasional) email or text message notifications. Click this link to join my new gallery.',
            following: [],
            mbshpsHidden: false,
            doSetHeader: true,
            posts: [],
            showShareGroup: false,
            showFirst: false,
            groupLink: '',
            startMode: 'private',
            startstep: 'starttab1'
          }
        },
        components:{
          'show-posts' : showPosts
        },
        computed: {
          isInitial() {
            return this.currentStatus === STATUS_INITIAL
          },
          isSaving() {
            return this.currentStatus === STATUS_SAVING
          },
          isSuccess() {
            return this.currentStatus === STATUS_SUCCESS
          },
          isFailed() {
            return this.currentStatus === STATUS_FAILED
          }
        },
        watch: {
          '$route' (to, from) {
            this.tabsHidden = false
          }
        },
        created() {
          if (!(window.location.href.match(/\/grp\//g) === null)) {
            var grp = window.location.pathname.substr(window.location.pathname.lastIndexOf('/') + 1)
            window.location.href = 'https://' + window.location.hostname + '/#/group/' + grp
            return
          }
          Vue.http.get('isAuthed').then((response) => {
            if(parseInt(response.body) != 1) {
              router.push('auth')
            } else {
              this.getPosts()
              this.getContacts()
              this.getSettings()
            }
          })
          if (typeof braintree !== "undefined") {
            this.subsHidden = false
          }
        },
        methods: {
          closeSponsor() {
            this.sponsorVisible = !this.sponsorVisible
          },
          showOptions() {
            this.optionsBtnHidden = true
            this.optionsHidden = false
          },
          onExpireChange(){
            //this.doExpire = !this.doExpire
          },
          showSubs() {
            if (typeof braintree !== "undefined") {
              this.settingsSpinnerHidden = false
              Vue.http.post( 'btSubs', {
              }).then( ( response ) => {
                this.linkVisible = false
                if (response.body[0].length > 0) {
                  this.subs = response.body[0]
                  this.noSubsTxt = ''
                }
                this.settingsSpinnerHidden = true
                this.subsVisible = true
              })
            }
          },
          showLink() {
            this.linkVisible = true
          },
          showHelp() {
            this.helpVisible = true
          },
          aftRec(data){
            MintUI.Toast({
              message: 'Click - Record 1 - and then click the floppy disk',
              iconClass: 'icon icon-success',
              duration: 4000
            })
          },
          getSettings() {
            Vue.http.get( 'getSettings').then( ( response ) => {
              if ( !!response.body ) {
                this.feedLink = response.body.feedLink
                this.feeds = JSON.parse(response.body.feedSubs)
              }
            })
          },
          getContacts() {
            Vue.http.get( 'getContacts').then( ( response ) => {
              if ( !!response.body ) {
                this.contacts = response.body[0]
                this.reloadGroups()
                if (this.contacts.length === 0) {
                  this.mbshpsHidden = true
                }
              }
            })
            Vue.http.get( 'getGroups').then( ( response ) => {
              if ( !!response.body ) {
                this.cgroups = response.body[0]
                this.reloadGroups()
                if (this.cgroups[this.cgroups.length - 1].name == 'My Photos') {
                  //this.gettingStarted = true
                  /*
                  MintUI.MessageBox({
                    title: 'Looks like you are new here',
                    message: 'Would you like to set up your first photo gallery?',
                    showCancelButton: true,
                    confirmButtonText: 'Yes take me there',
                    cancelButtonText: 'No thanks'
                  }).then(action => {
                    if (action === 'confirm') {
                      router.push( 'groups' )
                    }
                  })*/
                } else {
                  //this.gettingStarted = false
                  var check = false;
                  (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
                  if (check === false) {
                    /*
                    MintUI.Toast({
                      message: 'Desktop computer detected - if you need to Add Photos, we suggest you use a mobile device',
                      iconClass: 'icon icon-success',
                      duration: 3000
                    })*/
                  }
                }
              }
            })
          },
          reloadGroups() {
            this.lastgroups = []
            for (var i = 0; i < this.cgroups.length; i++) {
              this.cgroups[i].members = []
              this.cgroups[i].perms = []
              for (var j = 0; j < this.contacts.length; j++) {
                this.lastgroups.push([])
                if (this.contacts[j].groups.indexOf(this.cgroups[i].id) > -1) {
                  this.cgroups[i].members.push(this.contacts[j].id)
                  this.lastgroups[j].push(this.cgroups[i].id)
                }
                this.cgroups[i].perms.push({label: ' ',value: this.contacts[j].id})
              }
            }
          },
          cometAdd(item) {
            if (item.inreplyto.length > 0) {
              for (var j = 0; j < this.items.length; j++) {
                if (parseInt(this.items[j].id) === parseInt(item.inreplyto)) {
                  this.items[j].comments.unshift(item)
                }
              }
            } else {
              this.items.unshift(item)
            }
          },
          hideTabs() {
            this.tabsHidden = true
          },
          getPosts() {
            this.spinnerHidden = false
            Vue.http.get( 'getPosts' + '?cursor=' + this.cursor.toString()).then( ( response ) => {
              if ( !!response.body ) {
                if (this.cursor > 0) {
                  if (response.body[0].length < 10) {
                    this.moreHidden = true
                  }
                  for (var j = 0; j < response.body[0].length; j++) {
                    this.items.push(response.body[0][j])
                  }
                } else {
                  this.items = response.body[0]
                  if (this.items.length > 9) {
                    this.moreHidden = false
                  }
                  if (this.items.length == 0) {
                    this.showFirst = true
                    this.gettingStarted = true
                  }
                }
                this.groups = response.body[1]
                this.abilities = response.body[2]
                if (this.groups.length < 2) {
                  this.groupsHidden = true
                  this.postto = [this.groups[0].value]
                }
                if (this.comet == '') {
                  this.comet = response.body[3]
                  //var socket = io( '/rply/' + response.body[3] )
                  //socket.on( 'new item', this.cometAdd )
                }
                if (typeof braintree !== "undefined") {
                  if (this.cangrps.length == 0) {
                    for (var j = 0; j < response.body[4].length; j++) {
                      var grid = response.body[4][j]
                      Vue.http.post( 'joinGroup', {
                        grp:grid
                      }).then( ( response ) => {
                        this.cangrps.push({gname:response.body[1] + '',glink:response.body[4],guser:response.body[0]})
                      })
                    }
                  }
                }
                this.following = response.body[5]
              }
              this.spinnerHidden = true
            })

          },
          showSponsor(gr){
            this.sponsorGroup = gr.glink
            this.sponsorGroupName = 'Sponsor ' + gr.gname + ' with a monthly subscription'
            this.sponsorVisible = true
            if (false === this.btLoaded) {
              Vue.http.post( 'btSetup', {
              }).then( ( response ) => {
                this.btAuth = response.body[0]
                this.subs = response.body[1]
                this.createHostedFields()
                this.btLoaded = true
                this.formHidden = false
                this.btSpinnerHidden = true
              })
            }
          },
          addPosts(){
            if (this.postto.length == 0) {
              MintUI.Toast({
                message: 'Select gallery(s) for your post',
                iconClass: 'icon icon-success',
                duration: 4000
              })
              return
            }
            var exp = this.expireHours
            if (this.doExpire === false) {
              exp = 0
            }
            this.spinnerHidden = false
            this.saveHidden = true
            this.groupsHidden = true
            this.uploadHidden = true
            this.imgHidden = true
            Vue.http.post( 'addPosts', {
              recips:JSON.stringify(this.postto),
              title : this.title,
              expirehours: exp,
              speedup: this.speedup,
              doSetHeader: this.doSetHeader
            }).then( ( response ) => {
              if ( !!response.body ) {
                if (response.body[0].length > 3) {
                  this.groupLink = this.title + ' ' + response.body
                  this.showShareGroup = true
                }
              }
              this.selected = 'tab1'
              this.getPosts()
              this.title = ''
              this.image = ''
              this.postto = []
              this.spinnerHidden = true
              this.saveHidden = false
              this.uploadHidden = false
              this.groupsHidden = false
              this.reset()
            })
          },
          createHostedFields() {
            var postsobj = this
            if (typeof braintree !== "undefined" && this.btAuth != '') {
              braintree.setup(this.btAuth, "custom", {
                id: "cardForm",
                hostedFields: {
                  number: {
                    selector: "#card-number",
                    placeholder: "4111 1111 1111 1111"
                  },
                  cvv: {
                    selector: "#cvv",
                    placeholder: "111"
                  },
                  expirationDate: {
                    selector: "#expiration-date",
                    placeholder: "MM/YY"
                  },
                  postalCode: {
                    selector: "#postal-code",
                    placeholder: "32323"
                  },
                  styles: {
                    'input': {
                      'font-size': '16px',
                      'font-family': 'courier, monospace',
                      'font-weight': 'lighter',
                      'color': '#ccc'
                    },
                    ':focus': {
                      'color': 'black'
                    },
                    '.valid': {
                      'color': '#8bdda8'
                    }
                  }
                },
                onReady: function (integration) {
                  checkout = integration
                },
                onPaymentMethodReceived: function (nonce) {

                  Vue.http.post( 'doSponsor', {
                    method:JSON.stringify(nonce),
                    plan_id:postsobj.plan,
                    group_id:postsobj.sponsorGroup
                  }).then( ( response ) => {
                    MintUI.Toast({
                      message: 'Thank you! Bills as FLEETCODER on your Credit Card Statement.',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                  })
                  checkout.teardown(function () {
                    checkout = null
                    postsobj.createHostedFields()
                    postsobj.sponsorVisible = false
                  })
                }
              })
            }
          },
          doSponsor(nonce){
            Vue.http.post( 'addPosts', {
              recips:JSON.stringify(this.postto),
              title : this.title,
              expirehours: exp
            }).then( ( response ) => {
              this.selected = 'tab1'
              this.getPosts()
              this.title = ''
              this.image = ''
              this.postto = []
              this.spinnerHidden = true
              this.saveHidden = false
              this.uploadHidden = false
              this.groupsHidden = false
            })
            onPaymentMethodReceived
          },
          dropFeed(idx){
            Vue.http.post( 'dropFeed', {
              feed : idx
            }).then( ( response ) => {
              this.feeds = response.body
            })
          },
          doLogout(){
            Vue.http.post( 'logout', {
            }).then( ( response ) => {
              window.location.href = '/'
            })
          },
          doAddFeed(){
            Vue.http.post( 'addFeeds', {
              feed : this.addFeed
            }).then( ( response ) => {
              this.feeds = response.body
              this.addFeed = ''
            })
          },
          showFeeds(){
            this.linkVisible = false
            this.feedsVisible = true
          },
          closeSettings(){
            this.linkVisible = false
          },
          closeHelp(){
            this.helpVisible = false
          },
          closeFeeds(){
            this.feedsVisible = false
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => {
              if ( !!response.body ) {
                this[field] = response.body
                this.imgHidden = false
                this.uploadHidden = true
              }
            })
          },
          dropSponsor(idx){
            var postsobj = this
            MintUI.MessageBox({
              title: 'Stop Subscription',
              message: 'Are you sure?',
              showCancelButton: true,
              confirmButtonText: 'Stop Subscription',
              cancelButtonText: 'Cancel'
            }).then(action => {
              if (action === 'confirm') {
                this.spinnerHidden = false
                Vue.http.post( 'delSponsor', {
                  id:postsobj.subs[idx].id
                }).then( ( response ) => {
                  this.subs.splice( idx, 1 )
                  this.spinnerHidden = true
                })
              }
            })
          },
          quickContact(){
            this.showAddContact = true
          },
          cancelContact(){
            this.showAddContact = false
            this.newName = ''
            this.newEmail = ''
            this.newPhone = ''
            this.newContact = ''
          },
          checkConName() {
            this.validName = "success"
          },
          saveContact(){
            this.spinnerHidden = false
            Vue.http.post( 'quickAddContacts', {
              name : this.newName,
              email : this.newEmail,
              phone : this.newPhone
            }).then( ( response ) => {
              this.newName = ''
              this.newEmail = ''
              this.newPhone = ''
              this.newContact = ''
              this.getContacts()
              this.getPosts()
              this.showAddContact = false
            })
          },
          checkContact() {
            this.newPhone = ''
            this.newEmail = ''
            this.validContact = ''
            if (this.newContact.indexOf('@') !== -1) {
                var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                if (re.test(String(this.newContact).toLowerCase())) {
                  this.validContact = "success"
                  this.newEmail = this.newContact
                } else {
                  this.validContact = "error"
                }
              } else {
                if (this.newContact.substring(0, 2) == '+1') {
                  this.newContact = this.newContact.substring(2)
                }
                if (!(this.newContact.match(/\d/g) === null))
                  if (this.newContact.match(/\d/g).length===10) {
                    this.validContact = "success"
                    this.newPhone = this.newContact
                  } else {
                    this.validContact = "error"
                  }
              }

          },
          setGroups() {
            for (var j = 0; j < this.contacts.length; j++) {
              this.contacts[j].groups = []
              for (var i = 0; i < this.cgroups.length; i++) {
                if (this.cgroups[i].members.indexOf(this.contacts[j].id) > -1) {
                  if ("undefined" != typeof this.lastgroups[j]) {
                    if(this.lastgroups[j].indexOf(this.cgroups[i].id) !== -1){

                    } else {
                      this.contacts[j].groups.push(this.cgroups[i].id)
                      console.log(this.contacts[j].name + ' added ' + this.cgroups[i].name)
                      Vue.http.post( 'modContactGroups', {
                        id : this.contacts[j].id,
                        groups : JSON.stringify(this.contacts[j].groups.concat(this.lastgroups[j]))
                      }).then( ( response ) => {
                        if ( !!response.body ) {
                          this.groups = response.body[0]
                        }
                      })
                    }
                  }
                } else {
                  if ("undefined" != typeof this.lastgroups[j]) {
                    if(this.lastgroups[j].indexOf(this.cgroups[i].id) !== -1){
                      console.log(this.contacts[j].name + ' removed ' + this.cgroups[i].name)
                      const index = this.lastgroups[j].indexOf(this.cgroups[i].id)
                      if (index > -1) {
                        this.lastgroups[j].splice(index, 1)
                      }
                      Vue.http.post( 'modContactGroups', {
                        id : this.contacts[j].id,
                        groups : JSON.stringify(this.lastgroups[j])
                      }).then( ( response ) => {
                        if ( !!response.body ) {
                          this.groups = response.body[0]
                        }
                      })
                    }
                  }
                }
              }
            }
            this.lastgroups = []
            for (var j = 0; j < this.contacts.length; j++) {
              this.lastgroups.push([])
              this.lastgroups[j] = []
              for (var i = 0; i < this.cgroups.length; i++) {
                if (this.cgroups[i].members.indexOf(this.contacts[j].id) > -1) {
                  this.lastgroups[j].push(this.cgroups[i].id)
                }
              }
            }
          },
          closeSubs(){
            this.subsVisible = false
          },
          reset() {
            this.currentStatus = STATUS_INITIAL
            this.uploadedFiles = []
            this.uploadError = null
          },
          cancelUpload(){
            this.reset()
          },
          save(formData) {
            this.currentStatus = STATUS_SAVING
            this.$http.post ( this.uploadTo + '?field=image', formData ).then(function (x) {
              this.uploadedFiles = x.body[0]
              this.currentStatus = STATUS_SUCCESS
            })
          },
          filesChange(fieldName, fileList) {
            //if (isSaving() || isSuccess()) {
              const formData = new FormData()
              if (!fileList.length) return
              Array
                .from(Array(fileList.length).keys())
                .map(x => {
                  formData.append(fieldName, fileList[x], fileList[x].name)
                })
              this.save(formData)
           //}
          },
          moreItems(){
            this.cursor = this.items.length
            this.getPosts()
          },
          doShowSponsor(){
            this.showSponsor(this.doSponsor)
          },
          showHelpSection(section) {
            this['help1'] = false
            this['help2'] = false
            this['help3'] = false
            this[section] = true
          },
          copyTemplate1(){
            this.helpVisible = false
            MintUI.Toast({
              message: 'You just copied the photo caption text to your clipboard',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          copyTemplate2(){
            this.helpVisible = false
            MintUI.Toast({
              message: 'You just copied the direct message text to your clipboard',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          copyError(){
          },
          copyError2(){
          },
          onNotifChange(gid,type,value){
            this.spinnerHidden = false
            Vue.http.post( 'modGroupNotif', {
              id: gid,
              type: type,
              value: value
            }).then( ( response ) => {
              this.spinnerHidden = true
            })
          },
          copyFeedLink(){
            this.linkVisible = false
            MintUI.Toast({
              message: 'You just copied your private timeline feed link with password to your clipboard',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          takeMeThere(){
            router.push( '/groups' )
            this.selected = 'tab2'
          },
          copyGroupLink(){
            this.showShareGroup = false
            MintUI.Toast({
              message: 'You just copied the caption and gallery link to your clipboard',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          copyError(){
            MintUI.Toast({
              message: 'Sorry, there was an error copying the gallery link',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          closeShareGroup(){
            this.showShareGroup = false
          },
          setStartMode(){
          },
          closeFirst(){
            this.showFirst = false
            //this.gettingStarted = false
          }
        },
        mounted() {
          this.reset()
        },
        template: `
          <div>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-tab-container v-model="selected">
              <mt-tab-container-item id="tab1">
                <router-view v-bind:items="items" v-bind:posts.sync="posts" v-bind:doSponsor.sync="doSponsor" v-bind:postto.sync="postto" v-bind:selected.sync="selected" v-bind:editHidden="editHidden" v-bind:cangrps="cangrps" v-bind:moreHidden="moreHidden" @on-update-list="getPosts" @on-update-groups="getContacts" @on-tabs-hidden="hideTabs" @on-show-menu="showLink" @on-show-help="showHelp" @load-more-items="moreItems" @show-sponsor="doShowSponsor" />
                <h3 v-if="gettingStarted">Welcome!</h3>
              </mt-tab-container-item>
              <mt-tab-container-item id="tab2">
                <router-view name="middletab" v-bind:subsHidden="subsHidden" @on-update-photos="getPosts" v-bind:groups="groups" />
                  <!--<mt-cell>
                    <ul class="contacts">
                      <li class="contact" v-for="friend in contacts">{{ friend.name }}</li>
                    </ul>
                    <mt-checklist class="choosegroups" v-for="(group,idx) in cgroups" :title="cgroups[idx].name"
                      v-model="cgroups[idx].members"
                      :options="cgroups[idx].perms"
                      align="right"
                      v-on:change="setGroups()">
                    </mt-checklist>
                  </mt-cell>-->
              </mt-tab-container-item>
              <mt-tab-container-item id="tab3" class="addphotostab">
                <mt-header title=""></mt-header>
                <mt-cell v-bind:class="{'is-hidden':imgHidden}" title=""><img class="img" :src="'myFile?staged=1&field=image&name=' + image" /></mt-cell>
                <mt-cell>
                  <form enctype="multipart/form-data" novalidate v-if="isInitial">
                    <div class="dropbox">
                      <label class="uploadlabel" for="image_uploads">&nbsp; &nbsp; &nbsp; &nbsp; Click here to choose photos &nbsp; &nbsp; &nbsp; &nbsp; </label>
                      <input id="image_uploads" type="file" multiple :name="uploadFieldName" :disabled="isSaving" @change="filesChange($event.target.name, $event.target.files); fileCount = $event.target.files.length"
                        accept="image/*,video/mp4,video/x-m4v,video/*,audio/x-m4a,audio/*" class="input-file">
                    </div>
                  </form>
                  <p class="dropboxp" v-if="isSaving">
                    Uploading {{ fileCount }} files...
                    <mt-button type="primary" size="small" v-on:click="cancelUpload()">Cancel Uploading</mt-button>
                    <mt-spinner type="snake"></mt-spinner>
                  </p>
                  <div v-if="isSuccess">
                    <h2>Uploaded {{ uploadedFiles.length }} file(s) successfully.</h2>
                    <p>
                      <a href="javascript:void(0)" @click="reset()">Replace These Files</a>
                    </p>
                    <ul class="list-unstyled">
                      <li v-for="(item, idx) in uploadedFiles">
                        <img :src="'myFile?staged=1&field=image&multiname=' + item.url" class="img-responsive img-thumbnail" :alt="item.originalName" />
                        <mt-cell v-if="idx == 0" title="Use As Gallery Header Photo"><mt-switch v-model="doSetHeader"></mt-switch></mt-cell>
                        <mt-field v-if="idx == 0" placeholder="Caption..." type="textarea" rows="4" v-model="title"></mt-field>
                      </li>
                    </ul>
                  </div>
                  <div v-if="isFailed">
                    <h2>Uploaded failed.</h2>
                    <p>
                      <a href="javascript:void(0)" @click="reset()">Try again</a>
                    </p>
                    <pre>{{ uploadError }}</pre>
                  </div>
                </mt-cell>
                <audio-recorder v-bind:class="{'is-hidden':!audioHidden}" :upload-url="'uploadFile?field=sound'" :after-recording="aftRec" />
                <mt-cell><mt-field v-bind:class="{'is-hidden':!audioHidden}" placeholder="Speedup..." v-model="speedup" label="Frame rate multiplier"></mt-field></mt-cell>
                <mt-checklist v-bind:class="{'is-hidden':groupsHidden}"
                  v-model="postto"
                  :options="groups"
                  align="right">
                </mt-checklist>
                <!--<mt-button v-bind:class="{'is-hidden':saveHidden}" v-on:click="quickContact()" size="large">Add Contact</mt-button>-->
                <!--<mt-cell title="Expire after"><mt-field v-model="expireHours" label="hours"></mt-field><mt-switch v-model="doExpire" @change="onExpireChange()"></mt-switch></mt-cell>-->
                <!--<mt-button v-bind:class="{'is-hidden':optionsBtnHidden}" v-on:click="showOptions()" size="large">Options</mt-button>-->
                <mt-cell v-bind:class="{'is-hidden':optionsHidden}"><mt-switch class="options" v-model="audioHidden">Podcast</mt-switch><mt-switch class="options" v-model="textHidden">Caption</mt-switch></mt-cell>
                <mt-button v-bind:class="{'is-hidden':saveHidden}" v-on:click="addPosts()" size="large" id="savepostbutton">Save</mt-button>
              </mt-tab-container-item>
            </mt-tab-container>
            <mt-tabbar fixed="true" v-model="selected" v-bind:class="{'is-hidden':tabsHidden}">
              <mt-tab-item id="tab1">
                <img slot="icon" src="/file/list.svg" />
              </mt-tab-item>
              <!--<mt-tab-item id="tab2">
                <img slot="icon" src="/file/users.svg" />
                Manage
              </mt-tab-item>-->
              <mt-tab-item id="tab3">
                <img slot="icon" src="/file/plus-circle.svg" />
              </mt-tab-item>
            </mt-tabbar>
            <mt-popup class="help_popup" v-model="sponsorVisible" position="middle">
              <mt-header>
                <a v-on:click="closeSponsor()" slot="left">
                  <mt-button>X</mt-button>
                </a>
              </mt-header>
              <mt-cell :title="sponsorGroupName"></mt-cell>
              <mt-spinner v-bind:class="{'is-hidden':btSpinnerHidden}" type="snake"></mt-spinner>
              <form action="/" method="post" id="cardForm" v-bind:class="{'is-hidden':formHidden}">
                <label class="hosted-fields--label" for="card-number">Card Number</label>
                <div id="card-number" class="hosted-field"></div>
                <label class="hosted-fields--label" for="expiration-date">Expiration Date</label>
                <div id="expiration-date" class="hosted-field"></div>
                <label class="hosted-fields--label" for="cvv">CVV</label>
                <div id="cvv" class="hosted-field"></div>
                <label class="hosted-fields--label" for="cvv">Postal Code</label>
                <div id="postal-code" class="hosted-field"></div>
                <mt-radio v-model="plan" :options="plans"></mt-radio>
                <div class="button-container">
                  <input type="submit" class="button button--small button--green" value="Submit" id="submit"/>
                </div>
                <label class="hosted-fields--label">Cancel any time from the Settings menu</label>
              </form>
            </mt-popup>

            <mt-popup v-model="feedsVisible" position="middle">
              <mt-header>
                <a v-on:click="closeFeeds()" slot="left">
                  <mt-button>X</mt-button>
                </a>
              </mt-header>
              <mt-cell v-for="(url, idx) in feeds">
                <mt-field v-model="url"></mt-field>
                <a v-on:click="dropFeed(idx)">
                  <mt-button>X</mt-button>
                </a>
              </mt-cell>
              <mt-field placeholder="Paste a feed link..." v-model="addFeed"></mt-field>
              <mt-button v-on:click="doAddFeed()" size="large">Save Feed</mt-button>
            </mt-popup>

            <mt-popup v-model="subsVisible" position="middle">
              <mt-header>
                <a v-on:click="closeSubs()" slot="left">
                  <mt-button>X</mt-button>
                </a>
              </mt-header>
              <mt-cell v-for="(artist, idx) in subs">
                <mt-cell :title="artist.name">
                  <a v-on:click="dropSponsor(idx)">
                    <mt-button>X</mt-button>
                  </a>
                </mt-cell>
              </mt-cell>
              <p v-text="noSubsTxt"></p>
              <p>&nbsp;</p>
            </mt-popup>

            <mt-popup class="help_popup" v-model="helpVisible" position="middle">
              <mt-header>
                <a v-on:click="closeHelp()" slot="left">
                  <mt-button>X</mt-button>
                </a>
              </mt-header>
<!--
<h4 class="help_header" v-on:click="showHelpSection('help1')">Introduction</h4>
<p v-if="help1" class="help_para">RP.LY is a new kind of digital photo gallery that helps photographers sell monthly subscriptions.</p>
<p v-if="help1" class="help_para">Gallery visitors are required to provide a validated email address or phone number before they can see the gallery photos.</p>
<p v-if="help1" class="help_para">Photographers then receive this information as a “Contact”, and gallery visitors will receive an occasional “gallery updated” notification by email or text message.</p>

<h4 class="help_header" v-on:click="showHelpSection('help2')">Setting up a gallery</h4>
<p v-if="help2" class="help_para">After you register or log in, you will see an empty gallery/feed. At the bottom are three tabs: Gallery, Manage and Add Photos.</p>
<p v-if="help2" class="help_para">To set up your first gallery, click on Manage -> Galleries -> My Photos -> Edit Gallery.</p>
<p v-if="help2" class="help_para">Now you should see your Gallery’s settings including the Name (change it from “My Photos” to something else).</p>
<p v-if="help2" class="help_para">Click the “Set Header Photo” button to upload a header image - this will be the public image for your gallery, this image will be visible to friends when you share the gallery with them, even before they click through and enter your gallery. You can use any size image for this photo and it will be used unmodified, we will add more specific size guidelines in the future. The gallery header image can be vertical or horizontal.</p>
<p v-if="help2" class="help_para">Options:</p>
<p v-if="help2" class="help_para">a) Scale down uploaded files - this setting will automatically reduce the size of the images you publish, if you set it to 1000pixels then all of your published horizontal images will be 1000pixels wide or smaller, and your vertical images will be 1000pixels tall or smaller. This setting can be disabled completely by sliding the switch so that the blue part is hidden.</p>
<p v-if="help2" class="help_para">b) Block members from saving photos - this setting will block gallery visitors from saving your images to their phone’s camera roll.</p>
<p v-if="help2" class="help_para">c) Allow members to add photos - this setting will allow all gallery visitors to add photos to your gallery.</p>

<h4 class="help_header" v-on:click="showHelpSection('help3')">Contacts</h4>
<p v-if="help3" class="help_para">Contacts are created for every visitor who joins any of your galleries, a single contact can be a member of many of your galleries or just one.</p>
<p v-if="help3" class="help_para">Members of galleries are managed by clicking the “Manage” tab. At the top of the manage tab are radio buttons which allow you to add and remove gallery memberships. When you remove a member from a gallery, the images from that gallery will no longer appear in their photo feed.</p>
<p v-if="help3" class="help_para">The easiest way to create contacts is to allow your friends and family to join your gallery themselves, but you can also create a gallery and add people to it yourself. Galleries are private/hidden until you share the link with someone or post the link on your social media profiles.</p>
<p v-if="help3" class="help_para">To add a contact: click on Manage -> Contacts -> Add Contact.</p>

<h4 class="help_header" v-on:click="showHelpSection('help4')">Payments</h4>
<p v-if="help4" class="help_para">Payments are money you have earned. They are created from credit card subscription payments when your friends sponsor a gallery. Each gallery has a button at the bottom that says “Become a Sponsor”. The options are $3/monthly or $3/twice-yearly. Photographers will see payments of $2.70 (90%) each time someone becomes a sponsor, and each time their subscription renews.</p>
<p v-if="help4" class="help_para">Disbursement is currently a manual process and can be requested by emailing info@rp.ly - PayPal and Venmo are the current disbursement options.</p>

<h4 class="help_header" v-on:click="showHelpSection('help5')">Sharing a gallery by text message</h4>
<p v-if="help5" class="help_para">To share a gallery by text message, click Manage -> Galleries -> [YOUR GALLERY].</p>
<p v-if="help5" class="help_para">Click the button that says “Copy Gallery Link” and that will copy the gallery link into your clipboard.</p>
<p v-if="help5" class="help_para">You can paste this link to a group-text of friends and they will see your gallery name and your gallery header image as a preview.</p>

<h4 class="help_header" v-on:click="showHelpSection('help6')">Sharing a gallery to Instagram</h4>
<p v-if="help6" class="help_para">Follow the instructions in [Sharing a gallery by text message] to copy the gallery link to your clipboard.</p>
<p v-if="help6" class="help_para">Go to your Instagram profile and click “Edit Profile”.</p>
<p v-if="help6" class="help_para">Click “Website” and paste your gallery link and click “Done”.</p>
<p v-if="help6" class="help_para">Ideally you will have multiple photos to publish, you can publish one of them to Instagram and make sure to include a comment “Click link in bio for more images…”.</p>
<p v-if="help6" class="help_para">
        <h5 v-if="help6">Template: Instagram photo caption:</h5>
        <mt-field class="templtext" v-if="help6" type="textarea" rows="3" v-text="template1"></mt-field>
        <mt-button v-if="help6" size="large" v-clipboard:copy="template1" v-clipboard:success="copyTemplate1" v-clipboard:error="copyError" class="buttonset">Copy To Clipboard</mt-button>
</p>
<p v-if="help6" class="help_para">
        <h5 v-if="help6">Template: Instagram Direct Message:</h5>
        <mt-field class="templtext" v-if="help6" type="textarea" rows="3" v-text="template2"></mt-field>
        <mt-button v-if="help6" size="large" v-clipboard:copy="template2" v-clipboard:success="copyTemplate2" v-clipboard:error="copyError2" class="buttonset">Copy To Clipboard</mt-button>
</p>

<h4 class="help_header" v-on:click="showHelpSection('help7')">Sharing a gallery to Facebook</h4>
<p v-if="help7" class="help_para">Follow the instructions in [Sharing a gallery by text message] to copy the gallery link to your clipboard.</p>
<p v-if="help7" class="help_para">Create a new post on Facebook and “paste” your gallery link.</p>
<p v-if="help7" class="help_para">Facebook has an automated feature that will retrieve your gallery header image and gallery name.</p>

<h4 class="help_header" v-on:click="showHelpSection('help8')">Sharing a gallery by email</h4>
<p v-if="help8" class="help_para">You will need to use a Desktop computer for the following step, you can log in with your same phone number or email that you signed up with.</p>
<p v-if="help8" class="help_para">To share a gallery by email, click Manage -> Galleries -> [YOUR GALLERY]</p>
<p v-if="help8" class="help_para">Click the button that says “Download Gallery HTML File” and that will cause your computer to start downloading a file - save the file to your Desktop - or anywhere that you can find it.</p>
<p v-if="help8" class="help_para">Double-click the file to open it in Safari (this procedure has been tested in Safari but not other browsers). You should see your gallery name and gallery header image.</p>
<p v-if="help8" class="help_para">Now you can select-all and copy the contents of the browser window. On a Mac this is done with Command-A and then Command-C. On Windows you can Control-A and Control-C.</p>
<p v-if="help8" class="help_para">After you copy the content, you will be able to paste it into a new Gmail message or other mail app.</p>
-->
        <h4 class="help_header" v-on:click="showHelpSection('help1')">Share with friends</h4>
        <div class="firstHelp help_para" v-if="help1">
          <vue-plyr class="startVid">
            <video src="https://rp.ly/file/demoprivate1.mp4" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
          </vue-plyr>
        </div>
        <h4 class="help_header" v-on:click="showHelpSection('help2')">Share on social media</h4>
        <div class="firstHelp help_para" v-if="help2">
          <vue-plyr class="startVid">
            <video src="https://rp.ly/file/demopublic1.mp4" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
          </vue-plyr>
        </div>
        <h4 class="help_header" v-on:click="showHelpSection('help3')">It's a network</h4>
        <div class="firstHelp help_para" v-if="help3">
          <vue-plyr class="startVid">
            <video src="https://rp.ly/file/demonetwork1.mp4" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
          </vue-plyr>
        </div>
        <h4 class="help_header" v-on:click="showHelpSection('help4')">Contact Us</h4>
        <div class="firstHelp help_para mailto" v-if="help4">
            <a href="mailto:info@rp.ly">info@rp.ly</a>
        </div>
            </mt-popup>

            <mt-popup class="help_popup" v-model="linkVisible" position="middle">
              <mt-header>
                <a v-on:click="closeSettings()" slot="left">
                  <mt-button>X</mt-button>
                </a>
              </mt-header>
              <h3>Notifications</h3>
              <div v-for="(item,idx) in following">
                <h4 v-text="item.name"></h4>
                <div>
                  <h5 v-text="'Limit: ' + item.freq + ' per ' + item.interval"></h5>
                  <mt-radio
                    @change="onNotifChange(item.id,'interval',item.interval)"
                    v-model="item.interval"
                    :options="['Day', 'Week']">
                  </mt-radio>
                  <mt-range class="freqrange"
                    @change="onNotifChange(item.id,'freq',item.freq)"
                    v-model="item.freq"
                    :min="1"
                    :max="10"
                    :step="1"
                    :bar-height="5">
                    <div slot="start">1</div>
                    <div slot="end">10</div>
                  </mt-range>
                  <mt-cell>
                    <mt-switch class="notifswitch" v-model="item.email" @change="onNotifChange(item.id,'email',item.email)">Email</mt-switch>
                    <mt-switch class="notifswitch" v-model="item.phone" @change="onNotifChange(item.id,'phone',item.phone)">Text Msg</mt-switch>
                  </mt-cell>
                </div>
              </div>
              <mt-cell v-bind:class="{'is-hidden':subsHidden}"></mt-cell>
              <mt-cell v-bind:class="{'is-hidden':subsHidden}" title="Artists you sponsor"></mt-cell>
              <mt-button v-bind:class="{'is-hidden':subsHidden}" v-on:click="showSubs()" size="large">Sponsorships</mt-button>
              <mt-cell v-bind:class="{'is-hidden':subsHidden}"></mt-cell>
              <mt-cell></mt-cell>
              <mt-cell title="Paste feed links to follow content from other sites"></mt-cell>
              <mt-button v-on:click="showFeeds()" size="large">Feeds</mt-button>
              <mt-cell></mt-cell>
              <mt-cell title="Password feed link for your private feed"></mt-cell>
              <mt-field v-model="feedLink"></mt-field>
              <mt-button size="large" v-clipboard:copy="feedLink" v-clipboard:success="copyFeedLink" v-clipboard:error="copyError">Copy To Clipboard</mt-button>
              <mt-cell></mt-cell>
              <mt-button v-on:click="doLogout()" size="large">Logout</mt-button>
              <mt-cell></mt-cell>
            </mt-popup>
            
            <mt-popup class="addcontact" v-model="showAddContact" position="middle">
              <mt-field :state="validName" placeholder="Name" @keyup.native="checkConName" v-model="newName"></mt-field>
              <mt-field :state="validContact" @keyup.native="checkContact" placeholder="Email or Phone..." v-model="newContact" type="email"></mt-field>
              <mt-button v-on:click="cancelContact()">Cancel</mt-button>&nbsp;<mt-button v-on:click="saveContact()" type="primary">Add Contact</mt-button>
            </mt-popup>
        
            <mt-popup class="addcontact" v-model="showShareGroup" position="middle">
              <mt-header>
                <a v-on:click="closeShareGroup()" slot="left">
                  <mt-button>X</mt-button>
                </a>
              </mt-header>
              <mt-field type="textarea" rows="4" v-model="groupLink"></mt-field>
              <mt-button v-clipboard:copy="groupLink" v-clipboard:success="copyGroupLink" v-clipboard:error="copyError">Copy To Clipboard</mt-button><p></p>
            </mt-popup>

            <mt-popup class="addcontact" v-model="showFirst" position="middle">
                <mt-header>
                  <a v-on:click="closeFirst()" slot="left">
                    <mt-button>X</mt-button>
                  </a>
                </mt-header>
                <h3 v-if="gettingStarted">Choose how you want to share photos:</h3>
                <mt-radio v-if="gettingStarted"
                  title=""
                  v-model="startMode"
                  :options="['with friends', 'on social media']"
                  v-on:change="setStartMode()">
                </mt-radio>
                <div v-if="gettingStarted" v-if="startMode == 'with friends'" class="firstHelp">
          <vue-plyr class="startVid">
            <video src="https://rp.ly/file/demoprivate1.mp4" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
          </vue-plyr>
                </div>
                <div v-if="gettingStarted" v-if="startMode == 'on social media'" class="firstHelp">
          <vue-plyr class="startVid">
            <video src="https://rp.ly/file/demopublic1.mp4" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
          </vue-plyr>
                </div>
                <p>&nbsp;</p>
                <!--
                <h3 v-if="gettingStarted"> Click on Add Photos to share in a private gallery and send the link to friends.</h3>
                <h3 v-if="gettingStarted">Or, click the Public option in settings to make a public landing page.</h3>
                <p v-if="gettingStarted">
                  <a href="javascript:void(0)" @click="takeMeThere()">Take me to settings</a>
                </p>-->
            </mt-popup>
          
          </div>`
      }
      const listContacts = {
        data() {
          return {
            spinnerHidden : true
          }
        },
        props: { items : Array, editHidden: Boolean },
        methods: {
          delContacts( id, idx ){
            this.spinnerHidden = false
            Vue.http.post( 'delContacts', {
              id:id
            }).then( ( response ) => {
              this.items.splice( idx, 1 )
              this.spinnerHidden = true
            })
          },
          showAddContact(){
            this.$emit('on-show-add-contact')
          }
        },
        template: `
          <div class="feedwrap">
            <mt-header title="">
              <router-link to="/" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
                <mt-button slot="right"><img v-on:click="showAddContact()" class="headericon" slot="icon" src="/file/plus-circle.svg" />
                </mt-button>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell-swipe v-for="(item, idx) in items" :title="item.name" is-link :to="'/showContacts/' + idx" :right="[
              {
                content: 'Delete',
                style: { background: 'red', color: '#fff' },
                handler: () => delContacts( item.id, idx )
              }
            ]">
            </mt-cell-swipe>
          </div>`
      }
      const showContacts = {
        data() {
          return {
            spinnerHidden : true,
            idx: this.$route.params.idx,
            id : 0,
            name : '',
            email : '',
            phone : ''
          }
        },
        props: { items : Array },
        created() {
          if (this.items.length == 0) {
            this.$emit('on-update-list')
            setTimeout( function (self) {
              self.setData()
            }, 2000, this)
          } else {
            this.setData()
          }
        },
        methods: {
          setData(){
            this.id = this.items[ this.idx ].id
            this.name = this.items[ this.idx ].name
            this.email = this.items[ this.idx ].email
            this.phone = this.items[ this.idx ].phone
            this.$emit('on-tabs-hidden')
          },
          goEdit(idx) {
            router.push( '/modContacts/' + idx )
          }
        },
        template: `
          <div>
            <mt-header title="">
              <router-link to="/contacts" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell title="Name:" :value="name"></mt-cell>
            <mt-cell title="Email:" :value="email"></mt-cell>
            <mt-cell title="Phone:" :value="phone"></mt-cell>
            <mt-button size="large" v-on:click="goEdit(idx)">Edit Contact</mt-button>
          </div>`
      }
      const modContacts = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            idx: this.$route.params.idx,
            id : 0,
            name : '',
            email : '',
            phone : ''
          }
        },
        props: { items : Array },
        created() {
          this.id = this.items[ this.idx ].id
          this.name = this.items[ this.idx ].name
          this.email = this.items[ this.idx ].email
          this.phone = this.items[ this.idx ].phone

          this.$emit('on-tabs-hidden')
        },
        methods: {
          modContacts(){
            this.spinnerHidden = false
            Vue.http.post( 'modContacts', {
              id : this.id,
              name : this.name,
              email : this.email,
              phone : this.phone
            }).then( ( response ) => {
              this.$emit('on-update-list')
              router.push( '/' )
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => {
              if ( !!response.body ) {
                this[field] = response.body
              }
            })
          }
        },
        template: `
          <div>
            <mt-header title="">
              <router-link :to="'/showContacts/' + idx" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-field label="Name:" placeholder="Name.." v-model="name"></mt-field>
            <mt-field label="Email:" placeholder="Email..(optional)" v-model="email" type="email"></mt-field>
            <mt-field label="Phone:" placeholder="Phone..(optional)" v-model="phone"></mt-field>
            <mt-button v-on:click="modContacts()" size="large">Save</mt-button>
          </div>`
      }
      const Contacts = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            selected : 'tab1',
            items : [],
            tabsHidden: false,
            groups: [],
            abilities:[],
            editHidden:true,
            groupsHidden:false,
            postto:[],
            comet:'',
            name : '',
            email : '',
            phone : '',
            validEmail: '',
            validPhone: ''
          }
        },
        watch: {
          '$route' (to, from) {
            this.tabsHidden = false
          }
        },
        components:{
          'show-contacts' : showContacts
        },
        created() {
          this.getContacts()
        },
        methods: {
          showAddContactForm() {
            this.selected = "tab2"
          },
          hideAddContactForm() {
            this.selected = "tab1"
          },
          checkEmail() {
            this.validEmail = ''
            var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            if (re.test(String(this.email).toLowerCase())) {
              this.validEmail = "success"
            } else {
              this.validEmail = "error"
            }
          },
          checkPhone() {
            this.validPhone = ''
            if (this.phone.match(/\d/g).length===10) {
              this.validPhone = "success"
            } else {
              this.validPhone = "error"
            }
          },
          cometAdd(item) {
            this.items.unshift(item)
          },
          hideTabs() {
            this.tabsHidden = true
          },
          getContacts() {
            this.spinnerHidden = false
            Vue.http.get( 'getContacts').then( ( response ) => {
              if ( !!response.body ) {
                this.items = response.body[0]
                this.groups = response.body[1]
                this.abilities = response.body[2]
                if (this.abilities.indexOf("modSource Code") > -1) {
                  this.editHidden = false
                }
                if (this.groups.length < 2) {
                  this.groupsHidden = true
                  this.postto = [this.groups[0].value]
                }
                if (this.comet == '') {
                  this.comet = response.body[3]
                  //var socket = io( '/rply/' + response.body[3] )
                  //socket.on( 'new item', this.cometAdd )
                }
              }
              this.spinnerHidden = true
            })
          },
          addContacts(){
            this.spinnerHidden = false
            Vue.http.post( 'addContacts', {
              recips:JSON.stringify(this.postto),
              name : this.name,
              email : this.email,
              phone : this.phone
            }).then( ( response ) => {
              this.selected = 'tab1'
              this.getContacts()
              this.name = ''
              this.email = ''
              this.phone = ''
              Posts.getContacts()
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => {
              if ( !!response.body ) {
                this[field] = response.body
              }
            })
          }
        },
        template: `
          <div>

            <mt-tab-container v-model="selected">
              <mt-tab-container-item id="tab1">
                <router-view v-bind:items="items" v-bind:editHidden="editHidden" @on-update-list="getContacts" @on-tabs-hidden="hideTabs" @on-show-add-contact="showAddContactForm"  />
              </mt-tab-container-item>
              <mt-tab-container-item id="tab2">
                <mt-header title=""></mt-header>
                <mt-field placeholder="Name.." v-model="name"></mt-field>
                <mt-field :state="validEmail" @keyup.native="checkEmail" placeholder="Email..(optional)" v-model="email" type="email"></mt-field>
                <mt-field :state="validPhone" @keyup.native="checkPhone" placeholder="Phone..(optional)" v-model="phone"></mt-field>
                <mt-button v-on:click="addContacts()" size="large">Save</mt-button>
                <br />
                <mt-button v-on:click="hideAddContactForm()" size="large">
                    Cancel
                </mt-button>
                <mt-cell></mt-cell>
              </mt-tab-container-item>
            </mt-tab-container>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
          </div>`
      }
      const listGroups = {
        data() {
          return {
            spinnerHidden : true
          }
        },
        props: { items : Array, editHidden: Boolean },
        methods: {
          delGroups( id, idx ){
            this.spinnerHidden = false
            Vue.http.post( 'delGroups', {
              id:id
            }).then( ( response ) => {
              this.items.splice( idx, 1 )
              this.spinnerHidden = true
            })
          },
          showAddGroup(){
            this.$emit('on-show-add-group')
          }

        },
        template: `
          <div>
            <mt-header title="">
              <router-link to="/" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
                <mt-button slot="right"><img v-on:click="showAddGroup()" class="headericon" slot="icon" src="/file/plus-circle.svg" />
                </mt-button>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell-swipe v-for="(item, idx) in items" :title="item.name" is-link :to="'/showGroupPosts/' + item.id" :right="[
              {
                content: 'Delete',
                style: { background: 'red', color: '#fff' },
                handler: () => delGroups( item.id, idx )
              }
            ]">
              <img class="grimg" :src="'grpFile?field=image&name=' + item.image" />
            </mt-cell-swipe>
          </div>`
      }
      const showGroups = {
        data() {
          return {
            spinnerHidden : true,
            idx: this.$route.params.idx,
            id : 0,
            name : '',
            image : '',
            groupLink : '',
            inviteText: ' invited you to join '
          }
        },
        props: { items : Array },
        created() {
          if (this.items.length == 0) {
            this.$emit('on-update-list')
            setTimeout( function (self) {
              self.setData()
            }, 2000, this)
          } else {
            this.setData()
          }
        },
        methods: {
          setData(){
            console.log(this.items[ this.idx ])
            this.id = this.items[ this.idx ].id
            this.name = this.items[ this.idx ].name
            this.image = this.items[ this.idx ].image
            this.groupLink = 'https://rp.ly/grp/' + this.items[ this.idx ].key
            /*Vue.http.post( 'joinGroup', {
              grp:this.items[ this.idx ].key
            }).then( ( response ) => {
              this.groupEmbed = '<div style="font-family:courier,monospace;width:90%"><img style="height:auto;padding:30px;display:block;margin-left:auto;margin-right:auto;width:50%;padding:10px;" src="https://rp.ly/grpFile?field=image&name='
              this.groupEmbed = this.groupEmbed + encodeURIComponent(this.items[ this.idx ].image) + '" /><p style="text-align:center;display:block;padding:10px;">' + response.body[0] + this.inviteText + response.body[1] + '</p><a style="text-align:center;background-color:#32e0c4;display:block;color:black;text-decoration:none;padding:10px;" href="https://rp.ly/grp/' +  this.items[ this.idx ].key + '">' + 'Join ' + response.body[0] + "'s Gallery" + '</a></p></div>'
            })*/
            this.$emit('on-tabs-hidden')
          },
          goEdit(idx) {
            router.push( '/modGroups/' + idx )
          },
          copyGroupEmbed(){
            window.location.href = 'https://rp.ly/getGroupEmbed?grp=' + this.items[ this.idx ].key
          },
          copyGroupLink(){
            MintUI.Toast({
              message: 'You just copied the gallery link to your clipboard',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          copyError(){
            MintUI.Toast({
              message: 'Sorry, there was an error copying the gallery data',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          }
        },
        template: `
          <div>
            <mt-header title="">
              <mt-button slot="left" @click="$router.go(-1)" icon="back">back</mt-button>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell title="" :value="name"></mt-cell>
            <mt-cell>
              <div class="outer">
                <img class="oimg" :src="'grpFile?field=image&name=' + image" />
              </div>
            </mt-cell>
            <mt-button size="large" class="buttonset" v-on:click="goEdit(idx)">Gallery Settings</mt-button>
            <mt-button size="large" v-clipboard:copy="groupLink" v-clipboard:success="copyGroupLink" v-clipboard:error="copyError" class="buttonset">Copy Gallery Link</mt-button>
            <mt-button size="large" class="buttonset" v-on:click="copyGroupEmbed">Download Gallery HTML File</mt-button>
          </div>`
      }
      const modGroups = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            idx: this.$route.params.idx,
            id : 0,
            name : '',
            image : '',
            showAddContact: false,
            validName: '',
            validContact: '',
            newName:'',
            newContact:'',
            newEmail:'',
            newPhone:'',
            showShareGroup: false,
            groupLink: '',
            maxRes: '2000',
            doScale: false,
            blockDownloads: false,
            allowPosts: false,
            optsHidden: false,
            public: false,
            publicName: '',
            publicBio: '',
            publicImage: '',
            publicLink: '',
            publicGroups: [],
            pubHidden: false,
            publicPath: ''
          }
        },
        props: { items : Array, groups : Array },
        created() {
          this.id = this.items[ this.idx ].id
          this.name = this.items[ this.idx ].name
          this.image = this.items[ this.idx ].image
          if (this.items[ this.idx ].blockDownloads == '0') {
            this.blockDownloads = false
          }
          if (this.items[ this.idx ].allowPosts == '1') {
            this.allowPosts = true
          }
          if (this.items[ this.idx ].public == '1') {
            this.public = true
            this.changePublic()
          }
          var maxres = parseInt(this.items[ this.idx ].maxres)
          if (maxres > 0) {
            this.maxRes = this.items[ this.idx ].maxres
          }
          if (maxres === 0) {
            this.doScale = false
          }
          this.publicName = this.items[ this.idx ].publicName
          this.publicBio = this.items[ this.idx ].publicBio
          this.publicLink = this.items[ this.idx ].publicLink
          this.publicImage = this.items[ this.idx ].publicImage
          this.publicPath = this.items[ this.idx ].publicPath
          this.publicGroups = JSON.parse(this.items[ this.idx ].publicGroups)
          this.$emit('on-tabs-hidden')
          Vue.http.get( 'getPosts' ).then( ( response ) => {
            if ( !!response.body ) {
              this.groups = response.body[1]
            }
          })
        },
        methods: {
          closeShareGroup(){
            router.push( '/' )
          },
          checkContact() {
            this.newPhone = ''
            this.newEmail = ''
            this.validContact = ''
            if (this.newContact.indexOf('@') !== -1) {
                var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                if (re.test(String(this.newContact).toLowerCase())) {
                  this.validContact = "success"
                  this.newEmail = this.newContact
                } else {
                  this.validContact = "error"
                }
              } else {
                if (this.newContact.substring(0, 2) == '+1') {
                  this.newContact = this.newContact.substring(2)
                }
                if (!(this.newContact.match(/\d/g) === null))
                  if (this.newContact.match(/\d/g).length===10) {
                    this.validContact = "success"
                    this.newPhone = this.newContact
                  } else {
                    this.validContact = "error"
                  }
              }

          },
          checkConName() {
            this.validName = "success"
          },
          cancelContact(){
            this.showAddContact = false
            this.newName = ''
            this.newEmail = ''
            this.newPhone = ''
            this.newContact = ''
          },
          quickContact(){
            this.showAddContact = true
          },
          saveContact(){
            this.spinnerHidden = false
            Vue.http.post( 'quickAddContacts', {
              name : this.newName,
              email : this.newEmail,
              phone : this.newPhone,
              groups : JSON.stringify([this.id])
            }).then( ( response ) => {
              this.newName = ''
              this.newEmail = ''
              this.newPhone = ''
              this.newContact = ''
              this.showAddContact = false
            })
          },
          modGroups(){
            this.spinnerHidden = false
            if (this.name == 'My Photos') {
              this.spinnerHidden = true
              MintUI.Toast({
                message: 'Error, choose a different gallery name',
                iconClass: 'icon icon-error',
                duration: 2000
              })
              return
            }
            var exp = this.expireHours
            if (this.doExpire === false) {
              exp = 0
            }

            var sca = this.maxRes
            if (this.doScale === false) {
              sca = 0
            }
            Vue.http.post( 'modGroups', {
              id : this.id,
              name : this.name,
              maxres : sca,
              allowPosts : this.allowPosts,
              blockDownloads: this.blockDownloads,
              public: this.public,
              publicName: this.publicName,
              publicBio: this.publicBio,
              publicLink: this.publicLink,
              publicGroups: JSON.stringify(this.publicGroups),
              publicPath: this.publicPath
            }).then( ( response ) => {
              this.$emit('on-update-list')
              this.$emit('on-update-photos')
              //this.showShareGroup = true
              this.groupLink = response.body
              router.push('/')
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => {
              if ( !!response.body ) {
                this[field] = response.body
              }
            })
          },
          comingSoon(){
            MintUI.Toast({
              message: 'Sorry, this setting cannot be changed at this time',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          copyGroupLink(){
            router.push( '/' )
            MintUI.Toast({
              message: 'You just copied the gallery link to your clipboard',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          copyError(){
            MintUI.Toast({
              message: 'Sorry, there was an error copying the gallery link',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          changePublic(){
            this.pubHidden = !this.pubHidden
          }
        },
        template: `
          <div class="feedwrap">
            <mt-header title="">
              <!--<router-link :to="'/showGroups/' + idx" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>-->
              <mt-button slot="left" @click="$router.go(-2)" icon="back">back</mt-button>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-field label="Gallery Name:" placeholder="Name.." v-model="name"></mt-field>
            <!--<mt-cell title=""><img class="img" :src="'myFile?staged=1&field=image&name=' + image" /></mt-cell>-->
            <!--<file-upload btn-label="Set Header Photo" @change="stagedUpload('image')" :url="uploadTo + '?field=image'"></file-upload>-->
            <!--<mt-button v-on:click="quickContact()" size="large">Add Contact</mt-button>-->
            <mt-cell title="Public"><mt-switch v-model="public" @change="changePublic()"></mt-switch></mt-cell>
            <mt-field v-bind:class="{'is-hidden':!pubHidden}" label="Author Name:" placeholder="Name.." v-model="publicName"></mt-field>
            <mt-field v-bind:class="{'is-hidden':!pubHidden}" label="Author Bio:" placeholder="Bio.." type="textarea" rows="4" v-model="publicBio"></mt-field>
            <mt-field v-bind:class="{'is-hidden':!pubHidden}" label="Author Home Page:" placeholder="Link.." v-model="publicLink"></mt-field>
            <h3 v-bind:class="{'is-hidden':!pubHidden}">Linked Galleries:</h3>
            <mt-checklist v-bind:class="{'is-hidden':!pubHidden}"
              v-model="publicGroups"
              :options="groups"
              align="left">
            </mt-checklist>
            <mt-cell v-bind:class="{'is-hidden':!pubHidden}" title=""><img class="img" :src="'myFile?staged=1&field=publicImage&name=' + publicImage" /></mt-cell>
            <file-upload v-bind:class="{'is-hidden':!pubHidden}" btn-label="Change Author Photo" @change="stagedUpload('publicImage')" :url="uploadTo + '?field=publicImage'"></file-upload>
            <mt-field label="Custom Link rp.ly/..." placeholder="linda" v-model="publicPath"></mt-field>
            <mt-cell title="Advanced Options"><mt-switch v-model="optsHidden"></mt-switch></mt-cell>
            <mt-cell v-bind:class="{'is-hidden':!optsHidden}"  title="Scale down uploaded files"><mt-field v-model="maxRes" label="maximum pixels"></mt-field><mt-switch v-model="doScale"></mt-switch></mt-cell>
            <mt-cell v-bind:class="{'is-hidden':!optsHidden}" title="Block members from saving photos"><mt-switch v-model="blockDownloads"></mt-switch></mt-cell>
            <!--<mt-cell title="Allow members to add photos"><mt-switch v-model="allowPosts"></mt-switch></mt-cell>-->
            <mt-button class="underpic" v-on:click="modGroups()" size="large">Save</mt-button>
            <mt-popup class="addcontact" v-model="showAddContact" position="middle">
              <mt-field :state="validName" placeholder="Name" @keyup.native="checkConName" v-model="newName"></mt-field>
              <mt-field :state="validContact" @keyup.native="checkContact" placeholder="Email or Phone..." v-model="newContact" type="email"></mt-field>
              <mt-button v-on:click="cancelContact()">Cancel</mt-button>&nbsp;<mt-button v-on:click="saveContact()" type="primary">Add Contact</mt-button>
            </mt-popup>
            <mt-popup class="addcontact" v-model="showShareGroup" position="middle">
              <mt-cell title="Copy and share this gallery link:"></mt-cell>
              <mt-field v-model="groupLink"></mt-field>
              <mt-button v-clipboard:copy="groupLink" v-clipboard:success="copyGroupLink" v-clipboard:error="copyError">Copy Link</mt-button>
              <mt-button v-on:click="closeShareGroup()">Close</mt-button>
            </mt-popup>
          </div>`
      }
      const Groups = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            selected : 'tab1',
            items : [],
            tabsHidden: false,
            groups: [],
            abilities:[],
            editHidden:true,
            groupsHidden:false,
            postto:[],
            comet:'',
            name : '',
            image: '',
            public: false,
            publicName: '',
            publicBio: '',
            publicImage: '',
            publicLink: '',
            publicPath: '',
            publicGroups: [],
            pubHidden: false,
            optGroups:[],
            upLabel: 'Set Author Photo',
            saveDisabled: true
          }
        },
        props: {groups: Array},
        watch: {
          '$route' (to, from) {
            this.tabsHidden = false
          }
        },
        components:{
          'show-groups' : showGroups
        },
        created() {
          this.getGroups()
          Vue.http.get( 'getPosts' ).then( ( response ) => {
            if ( !!response.body ) {
              this.optGroups = response.body[1]
            }
          })
        },
        methods: {
          showAddGroupForm() {
            this.selected = "tab2"
          },
          hideAddGroupForm() {
            this.selected = "tab1"
          },
          cometAdd(item) {
            this.items.unshift(item)
          },
          hideTabs() {
            this.tabsHidden = true
          },
          getGroups() {
            this.spinnerHidden = false
            Vue.http.get( 'getGroups').then( ( response ) => {
              if ( !!response.body ) {
                this.items = response.body[0]
                this.groups = response.body[1]
                this.abilities = response.body[2]
                if (this.abilities.indexOf("modSource Code") > -1) {
                  this.editHidden = false
                }
                if (this.groups.length < 2) {
                  this.groupsHidden = true
                  this.postto = [this.groups[0].value]
                }
                if (this.comet == '') {
                  this.comet = response.body[3]
                  //var socket = io( '/rplygroups/' + response.body[3] )
                  //socket.on( 'new item', this.cometAdd )
                }
                for (var i = 0; i < this.items.length; i++) {
                  if ("undefined" == typeof this.items[i].image) {
                    this.items[i].image = ''
                  }
                  if (parseInt(this.items[i].id) == parseInt(this.$route.params.grid)) {
                    router.push('/modGroups/' + i)
                  }
                }
                //if (this.items[this.items.length - 1].name == 'My Photos') {
                //  router.push('/modGroups/' + (this.items.length - 1))
                //}
              }
              this.spinnerHidden = true
            })
          },
          addGroups(){
            this.spinnerHidden = false
            if (this.name == 'My Photos') {
              this.spinnerHidden = true
              MintUI.Toast({
                message: 'Error, choose a different gallery name',
                iconClass: 'icon icon-error',
                duration: 2000
              })
              return
            }
            Vue.http.post( 'addGroups', {
              recips:JSON.stringify(this.postto),
              name : this.name,
              public: this.public,
              publicName: this.publicName,
              publicBio: this.publicBio,
              publicLink: this.publicLink,
              publicPath: this.publicPath,
              publicGroups: JSON.stringify(this.publicGroups)
            }).then( ( response ) => {
              this.selected = 'tab1'
              this.getGroups()
              this.name = ''
              this.publicName = ''
              this.publicBio = ''
              this.publicLink = ''
              this.publicGroups = []
              this.$emit('on-update-list')
              router.push('/')
              //Posts.getContacts()
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => {
              if ( !!response.body ) {
                this[field] = response.body
                this.upLabel = 'Change Author Photo'
              }
            })
          },
          getPosts(){
            this.$emit('on-update-photos')
          },
          changePublic(){
            this.pubHidden = !this.pubHidden
          },
          changeName(){
            if (this.name.length === 0) {
              this.saveDisabled = true
            } else {
              this.saveDisabled = false
            }
          }
        },
        template: `
          <div>
            <mt-tab-container v-model="selected">
              <mt-tab-container-item id="tab1">
                <router-view v-bind:items="items" v-bind:groups="groups" v-bind:editHidden="editHidden" @on-update-list="getGroups" @on-tabs-hidden="hideTabs" @on-show-add-group="showAddGroupForm" @on-update-photos="getPosts" />
              </mt-tab-container-item>
              <mt-tab-container-item id="tab2">
                <mt-header title="">
                  <a slot="left">
                    <mt-button slot="left" @click="$router.go(-1)" icon="back">back</mt-button>
                  </a>
                </mt-header>
                <mt-field label="Gallery Name:" placeholder="Your Gallery Name.." @keyup.native="changeName()" v-model="name"></mt-field>
                <mt-cell title="Public"><mt-switch v-model="public" @change="changePublic()"></mt-switch></mt-cell>
                <mt-field v-bind:class="{'is-hidden':!pubHidden}" label="Author Name:" placeholder="Name.." v-model="publicName"></mt-field>
                <mt-field v-bind:class="{'is-hidden':!pubHidden}" label="Author Bio:" placeholder="Bio.." type="textarea" rows="4" v-model="publicBio"></mt-field>
                <mt-field v-bind:class="{'is-hidden':!pubHidden}" label="Author Home Page:" placeholder="Link.." v-model="publicLink"></mt-field>
                <mt-field v-bind:class="{'is-hidden':!pubHidden}" label="Custom Link rp.ly/..." placeholder="linda" v-model="publicPath"></mt-field>
                <h3 v-bind:class="{'is-hidden':!pubHidden}">Linked Galleries:</h3>
                <mt-checklist v-bind:class="{'is-hidden':!pubHidden}"
                  v-model="publicGroups"
                  :options="optGroups"
                  align="left">
                </mt-checklist>
                <mt-cell v-bind:class="{'is-hidden':!pubHidden}" title=""><img class="img" :src="'myFile?staged=1&field=publicImage&name=' + publicImage" /></mt-cell>
                <file-upload v-bind:class="{'is-hidden':!pubHidden}" :btn-label="upLabel" @change="stagedUpload('publicImage')" :url="uploadTo + '?field=publicImage'"></file-upload>
                <mt-button class="buttonset" v-on:click="addGroups()" size="large" :disabled="saveDisabled">Save</mt-button>
                <!--<mt-button class="buttonset" v-on:click="hideAddGroupForm()" size="large">
                    Cancel
                </mt-button>-->
                <mt-cell></mt-cell>
              </mt-tab-container-item>
            </mt-tab-container>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
          </div>`
      }
      const Subscribers = {
        data() {
          return {
            spinnerHidden : true,
            items : [],
            comet : ''
          }
        },
        created() {
          this.getSubscribers()
        },
        methods: {
          cometAdd(item) {
            this.items.unshift(item)
          },
          getSubscribers() {
            this.spinnerHidden = false
            Vue.http.get( 'getSubscribers').then( ( response ) => {
              if ( !!response.body ) {
                this.items = response.body
              }
              this.spinnerHidden = true
            })
          }
        },
        template: `
          <div>
            <mt-header title="">
              <router-link to="/" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
            </mt-header>
            <mt-cell title="Amount - Date - Gallery - From"></mt-cell>
            <mt-cell v-for="(item, idx) in items" :title="item.amount + ' - ' + item.date + ' - ' + item.gallery + ' - ' + item.name"></mt-cell>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
          </div>`
      }
      const MidMenu = {
        data() {
          return {
          }
        },
        props: {subsHidden: Boolean, groups: Array},
        created() {
        },
        methods: {
        },
        template: `
          <div>
            <mt-header title="">
            </mt-header>
            <mt-cell is-link to="/groups" title="Galleries"></mt-cell>
            <mt-cell is-link to="/contacts" title="Contacts"></mt-cell>
            <mt-cell v-if="!subsHidden" is-link to="/subs" title="Payments"></mt-cell>
            <mt-cell></mt-cell>
          </div>`
      }
      const router = new VueRouter({routes:[
        { path: '', component: Posts,
          children: [{
            path: 'showPosts/:idx',
            component: showPosts
        },{
            path: 'modPosts/:idx',
            component: modPosts
        },{
            path: 'showGroupPosts/:grpid',
            components:{default: showGroupPosts, middletab: MidMenu}
        },{
            path: '',
            components:{ default: listPosts, middletab: MidMenu }
        },{
          path: '/groups/:grid', components:{default: Groups},
                    children: [{
                      path: '/showGroups/:idx',
                      component: showGroups
                  },{
                      path: '/modGroups/:idx',
                      component: modGroups
                  },{
                      path: '/groups/new',
                      component: listGroups
                  }]
        },{
          path: '/contacts', components:{default: listPosts, middletab: Contacts},
                    children: [{
                      path: '/showContacts/:idx',
                      component: showContacts
                  },{
                      path: '/modContacts/:idx',
                      component: modContacts
                  },{
                      path: '',
                      component: listContacts
                  }]
        },{
            path: '/subs',
            components:{default: listPosts, middletab: Subscribers}
        }
      
      ]},{
            path: '/connect/:code',
            component: connect
        },{
            path: '/showgroup/:grp',
            component: GroupPage
        },{
            path: '/pubgroup/:grp',
            component: PublicGroupPage
        },{
            path: '/group/:grp',
            component: ShowGroupPage
        },{
            path: '/auth',
            component: freeTrial
        }
      ]})
      const vueApp = new Vue({
        router
      }).$mount('#app')
    </script>

  </body>
  <script type="python" id="server">

@app.route('/migrateGall',methods=['GET','POST'])
def migrateGall():
  gall = 0
  newOwner = 0
  grp = get_one( 'groups', gall )[0]
  oldOwner = grp['user_id']
  pst = get_all( 'posts' )
  for p in pst:
    if 'groups' in p:
      if p['groups'] is not None:
        grps = json.loads(p['groups'])
        if gall in grps:
          if len(grps) < 2:
            obj = {'user_id':newOwner}
            mod_one( 'posts', obj, p['id'] )
  cts = get_all( 'contacts' )
  for c in cts:
    if 'groups' in c:
      if c['groups'] is not None:
        grps = json.loads(c['groups'])
        if gall in grps:
          if len(grps) < 2:
            obj = {'user_id':newOwner}
            mod_one( 'contacts', obj, c['id'] )
  ct = get_one( 'contacts', oldOwner )[0]
  if 'groups' in ct:
    if ct['groups'] is not None:
      grps = json.loads(ct['groups'])
      if gall in grps:
        grps.remove(gall)
        obj = {'groups':json.dumps(grps)}
        mod_one( 'contacts', obj, ct['id'] )
  ct = get_one( 'contacts', newOwner )[0]
  if 'groups' in ct:
    if ct['groups'] is not None:
      grps = json.loads(ct['groups'])
      grps.append(gall)
      obj = {'groups':json.dumps(grps)}
      mod_one( 'contacts', obj, ct['id'] )
  obj = {'user_id':newOwner}
  mod_one( 'groups', obj, gall )
  return 'OK'

@app.route('/setGroupNotif',methods=['GET','POST'])
def setGroupNotif():
  item = get_one_by( 'groups', request.form.get('grp'), 'key' )[0]
  settkey = 'group_' + str(item['id'])
  items = get_one_by( 'settings', settkey, 'name' )
  mysett = {
    'phone':'1',
    'email':'1',
    'freq':'2',
    'interval':'Day',
    'last_notif':str( timezone( 'US/Pacific' ).localize( datetime.now() - timedelta(hours=25) ) )
  }
  if len(items) > 0:
    for sett in items:
      if int(session['user']) == int(sett['user_id']):
        mysett = json.loads(sett['value'])
  mysett['freq'] = request.form.get('freq')
  mysett['interval'] = request.form.get('interval')
  if not len(items) > 0:
    sett = add_one('settings',{
      'user_id':session['user'],
      'name':settkey,
      'value':json.dumps(mysett)
    })
  else:
    found = False
    for sett in items:
      if int(session['user']) == int(sett['user_id']):
        mod_one('settings',{'value':json.dumps(mysett)},sett['id'])
        found = True
    if not found:
      sett = add_one('settings',{
        'user_id':session['user'],
        'name':settkey,
        'value':json.dumps(mysett)
      })
  return 'OK'

@app.route('/modGroupNotif',methods=['GET','POST'])
def modGroupNotif():
  item = get_one( 'groups', request.form.get('id') )[0]
  settkey = 'group_' + request.form.get('id')
  items = get_one_by( 'settings', settkey, 'name' )
  mysett = {
    'phone':'1',
    'email':'1',
    'freq':'2',
    'interval':'Day',
    'last_notif':str( timezone( 'US/Pacific' ).localize( datetime.now() - timedelta(hours=25) ) )
  }
  if len(items) > 0:
    for sett in items:
      if int(session['user']) == int(sett['user_id']):
        mysett = json.loads(sett['value'])
  if request.form.get('type') == 'freq':
    mysett['freq'] = request.form.get('value')
  if request.form.get('type') == 'interval':
    mysett['interval'] = request.form.get('value')
  if request.form.get('type') == 'email':
    if request.form.get('value') == 'true':
      mysett['email'] = '1'
    else:
      mysett['email'] = '0'
  if request.form.get('type') == 'phone':
    if request.form.get('value') == 'true':
      mysett['phone'] = '1'
    else:
      mysett['phone'] = '0'
  if not len(items) > 0:
    found = False
    sett = add_one('settings',{
      'user_id':session['user'],
      'name':settkey,
      'value':json.dumps(mysett)
    })
  else:
    found = False
    for sett in items:
      if int(session['user']) == int(sett['user_id']):
        mod_one('settings',{'value':json.dumps(mysett)},sett['id'])
        found = True
    if not found:
      sett = add_one('settings',{
        'user_id':session['user'],
        'name':settkey,
        'value':json.dumps(mysett)
      })
  return 'OK'

@app.route('/getGroupEmbed',methods=['GET','POST'])
def getGroupEmbed():
  invitetext = ' invited you to join '
  os.chdir(appdir)
  items = get_one_by( 'groups', request.args.get('grp'), 'key' )
  if not len(items) > 0:
    items = get_one( 'groups', request.args.get('grp') )
  result = []
  if len(items) > 0:
    owner = get_user(items[0]['user_id'])
    imgsrc = ''
    if not items[0]['image'] is None:
      imgsrc = urllib.parse.quote(items[0]['image'])
    html = '<div style="font-family:courier,monospace;width:90%"><img alt="gallery image for ' + items[0]['name'] + '" style="height:auto;padding:30px;display:block;margin-left:auto;margin-right:auto;width:50%;padding:10px;" src="https://' + mydomain + '/grpFile?field=image&name='
    html = html + imgsrc + '" /><p style="text-align:center;display:block;padding:10px;">' + owner['name'] + invitetext + items[0]['name'] + '</p><a style="text-align:center;background-color:#32e0c4;display:block;color:black;text-decoration:none;padding:10px;" href="https://' + mydomain + '/grp/' +  items[0]['key'] + '">' + 'Join ' + owner['name'] + "'s Gallery" + '</a></div>'
    response = make_response(html)
    response.mimetype = "text/html"
    regex = re.compile('[^a-zA-Z]')
    finame = regex.sub('', items[0]['name'])
    response.headers["Content-disposition"] = "attachment; filename=" + finame + '.html'
    return response
  return 'Error'

@app.route('/getSubscribers', methods=['GET','POST'])
def getSubscribers():
  subs = []
  curr = current_user()
  ugrps = get_one_by('groups',curr['id'],'user_id')
  ugrids = []
  for gr in ugrps:
    ugrids.append(str(gr['id']))
  if not os.getenv('BT_ID') is None:
    search_results = gateway.subscription.search(
      braintree.SubscriptionSearch.status.in_list(
        braintree.Subscription.Status.Active,
        braintree.Subscription.Status.Canceled,
        braintree.Subscription.Status.Expired,
        braintree.Subscription.Status.PastDue,
        braintree.Subscription.Status.Pending
      )
    )
    for sub in search_results:
      grpid = ''.join(x for x in sub.id if x.isdigit())
      if grpid in ugrids:
        items = get_one( 'groups', grpid )
        if len(items) > 0:
          owner = get_user(items[0]['user_id'])
          grpn = items[0]['name']
          for tr in sub.transactions:
            subs.append({'name':tr.customer_details.first_name,'gallery':grpn,'date':str(sub.created_at),'amount':'${:0,.2f}'.format(round(float(tr.amount) * 0.9,3))})
  return( json.dumps( subs ) )

@app.route('/delSponsor', methods=['GET','POST'])
def delSponsor():
  result = gateway.subscription.cancel(request.form.get('id'))
  return 'OK'

@app.route('/btSubs', methods=['GET','POST'])
def btSubs():
  subs = []
  if not os.getenv('BT_ID') is None:
    curr = current_user()
    if not curr['phone'] == '':
      collection = gateway.customer.search(
        braintree.CustomerSearch.phone == curr['phone']
      )
    if not curr['email'] == '':
      collection = gateway.customer.search(
        braintree.CustomerSearch.email == curr['email']
      )
    if not collection is None:
      if len(list(collection.items)) > 0:
        customer = list(collection.items)[0]
        if len(customer.credit_cards) > 0:
          for sub in customer.credit_cards[0].subscriptions:
            if sub.status == 'Active':
              owner = {'name':''}
              grpn = ''
              grpid = ''.join(x for x in sub.id if x.isdigit())
              items = get_one( 'groups', grpid )
              if len(items) > 0:
                owner = get_user(items[0]['user_id'])
                grpn = items[0]['name']
              subs.append({'name':owner['name'] + '/' + grpn + ' renews ' + str(sub.next_billing_date),'id':str(sub.id)})
  return( json.dumps( [subs] ) )

@app.route('/btSetup', methods=['GET','POST'])
def btSetup():
  subs = []
  tok = ''
  if not os.getenv('BT_ID') is None:
    tok = gateway.client_token.generate()
    return( json.dumps( [tok,subs] ) )
    curr = current_user()
    collection = gateway.customer.search(
      braintree.CustomerSearch.phone == curr['phone']
    )
    if len(list(collection.items)) > 0:
      customer = list(collection.items)[0]
    else:
      collection = gateway.customer.search(
        braintree.CustomerSearch.email == curr['email']
      )
      if len(list(collection.items)) > 0:
        customer = list(collection.items)[0]
    if len(list(collection.items)) > 0:
      for sub in customer.credit_cards[0].subscriptions:
        if sub.status == 'Active':
          subs.append({'name':'bills $3 on ' + str(sub.next_billing_date),'id':str(sub.id)})
  return( json.dumps( [tok,subs] ) )

@app.route('/doSponsor', methods=['GET','POST'])
def doSponsor():
  response = json.loads(request.form.get('method'))
  curr = current_user()
  collection = 0
  if not curr['phone'] == '':
    collection = gateway.customer.search(
      braintree.CustomerSearch.phone == curr['phone']
    )
  if not curr['email'] == '':
    collection = gateway.customer.search(
      braintree.CustomerSearch.email == curr['email']
    )
  if not collection == 0:
    if len(list(collection.items)) > 0:
      customer = list(collection.items)[0]
    else:
      result = gateway.customer.create({
        "first_name": curr['name'],
        "payment_method_nonce": response['nonce'],
        "email": curr['email'],
        "phone": curr['phone']
      })
      if result.is_success:
        customer = result.customer
    if not customer is None:
      if not len(customer.payment_methods) > 0:
        result = gateway.payment_method.create({
          "customer_id": customer.id,
          "payment_method_nonce": response['nonce']
        })
        if not curr['phone'] == '':
          collection = gateway.customer.search(
            braintree.CustomerSearch.phone == curr['phone']
          )
        if not curr['email'] == '':
          collection = gateway.customer.search(
            braintree.CustomerSearch.email == curr['email']
          )
        if len(list(collection.items)) > 0:
          customer = list(collection.items)[0]
      result = gateway.subscription.create({
        "payment_method_token": customer.payment_methods[0].token,
        "plan_id": request.form.get('plan_id'),
        "merchant_account_id":'Fleetcoder_instant',
        "id":randomword(6) + request.form.get('group_id')
      })
      if result.is_success:
        if not customer is None:
          notify_sponsor( request.form.get('plan_id'), request.form.get('group_id'), curr['name'] )
        print("success")
      else:
        print(result.errors)
  return 'OK'

@app.route('/doCode', methods=['GET','POST'])
def doCode():
  item = get_one_by( 'connectcodes', request.form.get('code'), 'num' )
  if len(item) > 0:
    for conn in item:
      if conn['code'] == request.form.get('connect'):
        del_one( 'connectcodes', conn['id'] )
        usr = get_one_by( 'contacts', request.form.get('connect'), 'code' )
        if len(usr) > 0 and usr[0]['user_id'] is None:
          u = usr[0]['id']
        else:
          if len(usr) > 0:
            if int(usr[0]['user_id']) > 0:
              exists = get_parent(usr[0]['id'])
              if exists['user_id'] is None:
                u = exists['id']
              else:
                ra = randomword(6)
                u = add_one('contacts',{
                  'name':usr[0]['name'],
                  'email':usr[0]['email'].lower(),
                  'phone':usr[0]['phone'],
                  'groups':json.dumps([2]),
                  'code':ra,
                  'created':str(datetime.now())
                })
                newrec = {
                  'name' : 'My Photos',
                  'image':'',
                  'maxres':'2000',
                  'allowPosts':'0',
                  'blockDownloads':'0',
                  'user_id' : u,
                  'key' : randomword(8),
                  'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
                }
                gr1 = add_one( 'groups', newrec )
                con = mod_one('contacts',{'groups': json.dumps([2,gr1])},u)
                update_abilities()
                ra = randomword(6)
                copy = get_user(usr[0]['user_id'])
                copy['user_id'] = u
                copy['groups'] = json.dumps([gr1])
                copy['code'] = ra
                del copy['id']
                con = add_one( 'contacts', copy )
        response = make_response(json.dumps( [ 'OK' ] ))
        session.permanent = True
        session['user'] = str(u)
        return response
  return json.dumps( [ 'Error' ] )

@app.route('/doConnect', methods=['GET','POST'])
def doConnect():
  num = randint(100, 999)
  add_one('connectcodes',{
    'num':num,
    'code':request.form.get('code')
  })
  item = get_one_by( 'contacts', request.form.get('code'), 'code' )
  cont = {}
  if 'user' in session:
    if int(session['user']) == int(item[0]['id']):
      return json.dumps( [ 'OK' ] )
    exists = get_parent(item[0]['id'])
    if 'user_id' in exists and exists['user_id'] is None:
      if int(session['user']) == int(exists['id']):
        return json.dumps( [ 'OK' ] )
  cont['phone'] = item[0]['phone']
  cont['email'] = item[0]['email']
  if len(cont['phone']) > 0:
    client = Client(twilio_id, twilio_token)
    rl = "Your code is " + str(num)
    message = client.messages.create(
      body=rl,
      from_='+1' + os.getenv('TWILIO_FROM'),
      to=cont['phone']
    )
    return json.dumps( [ 'phone number' ] )
  if len(cont['email']) > 0:
    em = cont['email']
    message = Mail(
      from_email=' Request at ' + mydomain + ' <' + os.getenv('SENDGRID_FROM') + '>',
      to_emails=em,
      subject='Your ' + mydomain + ' connection code is ' + str(num),
      html_content='<strong>Your code is ' + str(num) + '</strong>')
    sg = SendGridAPIClient(sendgrid_token)
    response = sg.send(message)
    return json.dumps( [ 'email address' ] )
  return json.dumps( [ 'Error' ] )

@app.route('/freeTrial', methods=['GET','POST'])
def freeTrial():
    cont = {}
    cont['phone'] = request.form.get("phone")
    cont['email'] = request.form.get("email")
    cont['name'] = request.form.get("name")
    newuser = ''
    if len(cont['phone']) > 0:
      loginuser = cont['phone']
      usr = get_one_by('contacts',loginuser,'phone')
    if len(cont['email']) > 0:
      loginuser = cont['email']
      usr = get_one_by('contacts',loginuser,'email')
    if len(usr) > 0 and usr[0]['user_id'] is None:
      return json.dumps(['error'])
    num = randint(100, 999)
    cont = {}
    cont['phone'] = request.form.get("phone")
    cont['email'] = request.form.get("email").lower()
    add_one('connectcodes',{
      'num':num,
      'email':cont['email'],
      'phone':cont['phone']
    })
    if len(cont['phone']) > 0:
      client = Client(twilio_id, twilio_token)
      rl = "Your " + mydomain + " code is " + str(num)
      message = client.messages.create(
        body=rl,
        from_='+1' + os.getenv('TWILIO_FROM'),
        to=cont['phone']
      )
    if len(cont['email']) > 0:
      em = cont['email']
      message = Mail(
        from_email=os.getenv('SENDGRID_FROM'),
        to_emails=em,
        subject='Your ' + mydomain + ' connection code is ' + str(num),
        html_content='<strong>Your code is ' + str(num) + '</strong>')
      sg = SendGridAPIClient(sendgrid_token)
      response = sg.send(message)
    return 'OK'

@app.route('/freeTrialLogin', methods=['GET','POST'])
def freeTrialLogin():
    cont = {}
    cont['phone'] = request.form.get("phone")
    cont['email'] = request.form.get("email")
    cont['name'] = request.form.get("name")
    newuser = ''
    if len(cont['phone']) > 0:
      loginuser = cont['phone']
      usr = get_one_by('contacts',loginuser,'phone')
      if len(usr) > 0:
        exists = get_parent(usr[0]['id'])
    if len(cont['email']) > 0:
      loginuser = cont['email']
      usr = get_one_by('contacts',loginuser,'email')
      if len(usr) > 0:
        exists = get_parent(usr[0]['id'])
    if not (len(usr) > 0 and exists['user_id'] is None):
      return json.dumps(['error'])
    num = randint(100, 999)
    cont = {}
    cont['phone'] = request.form.get("phone")
    cont['email'] = request.form.get("email").lower()
    add_one('connectcodes',{
      'num':num,
      'email':cont['email'],
      'phone':cont['phone']
    })
    if len(cont['phone']) > 0:
      client = Client(twilio_id, twilio_token)
      rl = "Your " + mydomain + " code is " + str(num)
      message = client.messages.create(
        body=rl,
        from_='+1' + os.getenv('TWILIO_FROM'),
        to=cont['phone']
      )
    if len(cont['email']) > 0:
      em = cont['email']
      message = Mail(
        from_email=os.getenv('SENDGRID_FROM'),
        to_emails=em,
        subject='Your ' + mydomain + ' connection code is ' + str(num),
        html_content='<strong>Your code is ' + str(num) + '</strong>')
      sg = SendGridAPIClient(sendgrid_token)
      response = sg.send(message)
    return 'OK'

@app.route('/freeTrialStart', methods=['GET','POST'])
def freeTrialStart():
  addgrp = None
  if not request.form.get('grp') is None:
    items = get_one_by( 'groups', request.form.get('grp'), 'key' )
    addgrp = items[0]['id']
  cont = {}
  usr = []
  cont['phone'] = request.form.get("phone")
  cont['email'] = request.form.get("email").lower()
  cont['name'] = request.form.get("name")
  newuser = ''
  if len(cont['phone']) > 0:
    newuser = cont['phone']
    usr = get_one_by('contacts',newuser,'phone')
  if len(cont['email']) > 0:
    newuser = cont['email']
    usr = get_one_by('contacts',newuser,'email')
  os.chdir(appdir)
  tri = get_one_by('connectcodes',request.form.get("code"),'num')
  email = ''
  phone = ''
  for cocode in tri:
    email = cocode['email']
    phone = cocode['phone']
    if cont['email'] is None:
      cont['email'] = ''
    if (cont['phone'] == phone or cont['email'].lower() == email):
      del_one( 'connectcodes', cocode['id'] )
      break
  if not (cont['phone'] == phone or cont['email'].lower() == email):
    return '0'
  if ('' == phone and '' == email):
    return '0'
  ra = randomword(6)
  if len(usr) > 0 and usr[0]['user_id'] is None:
    u = usr[0]['id']
  else:
    exists = {}
    if len(usr) > 0:
      exists = get_parent(usr[0]['id'])
    if 'user_id' in exists and exists['user_id'] is None:
      u = exists['id']
    else:
      newgrp = [2]
      u = add_one('contacts',{
        'name':cont['name'],
        'email':cont['email'].lower(),
        'phone':cont['phone'],
        'groups':json.dumps(newgrp),
        'code':ra,
        'created':str(datetime.now())
      })
      newrec = {
        'name' : 'My Photos',
        'image':'',
        'maxres':'2000',
        'allowPosts':'0',
        'blockDownloads':'0',
        'user_id' : u,
        'key' : randomword(8),
        'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
      }
      gr1 = add_one( 'groups', newrec )
      con = mod_one('contacts',{'groups': json.dumps(newgrp + [gr1])},u)
      update_abilities()
  response = make_response(json.dumps( [ 'OK' ] ))
  session.permanent = True
  session['user'] = str(u)
  if not addgrp is None:
    usr = current_user()
    grpdata = get_one('groups',addgrp)
    if 'user_id' in grpdata[0]:
      growner = get_user(grpdata[0]['user_id'])
      share_my_contact(growner,[addgrp])
  return response

@app.route("/isAuthed", methods=['GET'])
def isAuthed():
  os.chdir(appdir)
  if 'user' in session:
    if int(session['user']) > 0:
      return '1'
  return '0'

@app.route("/logout", methods=['POST','GET'])
def logout():
  os.chdir(appdir)
  response = make_response('1')
  session['user'] = '0'
  return response

@app.route('/feed',methods=['GET','POST'])
def feed():
  limit = 25
  items = get_one_by( 'settings', 'https://' + mydomain + '/feed?k=' + request.args.get('k'), 'value' )
  if len(items) > 0:
    user = get_user(items[0]['user_id'])
    recs = get_all('posts')
    groups = json.loads(user['groups'])
    items = []
    for item in recs:
      if can('get','posts',user,item):
        item['title'] = get_user(item['user_id'])['name']
        pgrps = json.loads(item['groups'])
        for pgrp in pgrps:
          if pgrp in groups:
            thisgroup = get_one( 'groups', pgrp )
            if len(thisgroup) > 0:
              item['title'] = item['title'] + ' - ' + thisgroup[0]['name']
        items.append(item)
        if len(items) == limit:
          break
    channel = etree.Element('channel')
    etree.SubElement(channel,'title').text = 'Feed'
    etree.SubElement(channel,'link').text = 'https://' + mydomain
    etree.SubElement(channel,'description').text = ''
    for post in items:
      item = etree.Element('item')
      etree.SubElement(item,'title').text = post['title']
      d = post['created']
      if ":" == d[-3]:
        d = d[:-3]+d[-2:]
      etree.SubElement(item,'pubDate').text = utils.format_datetime(datetime.strptime(d, "%Y-%m-%d %H:%M:%S.%f%z"))
      enc = etree.Element('enclosure')
      if not post['sound'] is None:
        mtype = mimetypes.MimeTypes().guess_type(post['sound'])[0]
      if not mtype is None:
        if post['sound'][-3:] == 'mp3':
          enc.set('url', 'https://' + mydomain + '/myFile?name=' + urllib.parse.quote(post['sound']) + '&field=sound')
          if os.path.exists('myfiles/' + post['sound']):
            enc.set('length', str(os.path.getsize('myfiles/' + post['sound'])))
            enc.set('type', mtype)
            item.append(enc)
      elif not post['video'] is None:
        mtype = mimetypes.MimeTypes().guess_type(post['video'])[0]
        if post['video'][-3:].lower() in ['mov','mp4']:
          enc.set('url', 'https://' + mydomain + '/myFile?name=' + urllib.parse.quote(post['video']) + '&field=video')
          if os.path.exists('myfiles/' + post['video']):
            enc.set('length', str(os.path.getsize('myfiles/' + post['video'])))
            enc.set('type', mtype)
            item.append(enc)
        else:
          enc = etree.Element('enclosure')
          if not post['image'] is None:
            mtype = mimetypes.MimeTypes().guess_type(post['image'])[0]
          if not mtype is None:
            enc.set('url', 'https://' + mydomain + '/myFile?name=' + urllib.parse.quote(post['image']) + '&field=image')
            if os.path.exists('myfiles/' + post['image']):
              enc.set('length', str(os.path.getsize('myfiles/' + post['image'])))
              enc.set('type', mtype)
              item.append(enc)
      channel.append(item)
    root = etree.Element('rss')
    root.set('version', '2.0')
    root.append(channel)
    resp = make_response(etree.tostring(root, pretty_print=True).decode('utf-8'))
    resp.mimetype = "application/rss+xml"
    return resp
  return str(0)

@app.route('/getSettings',methods=['GET','POST'])
def getSettings():
  if not 'user' in session:
    return json.dumps([])
  items = get_one_by( 'settings', session['user'], 'user_id' )
  has_key = False
  if len(items) > 0:
    for sett in items:
      if sett['name'] == 'feedLink':
        has_key = True
  if not len(items) > 0 or not has_key:
    sett = add_one('settings',{
      'name':'feedLink',
      'value':'https://' + mydomain + '/feed?k=' + randomword(19),
      'user_id':session['user']
    })
    sett = add_one('settings',{
      'name':'feedSubs',
      'value':'[]',
      'user_id':session['user']
    })
  items = get_one_by( 'settings', session['user'], 'user_id' )
  sett = {}
  for it in items:
    sett[it['name']] = it['value']
  return json.dumps(sett)

@app.route('/getPosts',methods=['GET','POST'])
def getPosts():
  allowgroups = get_one_by('groups','0','blockDownloads')
  allowdownload = []
  if len(allowgroups) > 0:
    for all in allowgroups:
      allowdownload.append(int(all['id']))
  user = current_user()
  recs = get_all('posts')
  posts = []
  cangrps = []
  groups = json.loads(user['groups'])
  ugrps = []
  if 'id' in user:
    ugrps = get_one_by('groups',user['id'],'user_id')
  ugrids = []
  for gr in ugrps:
    ugrids.append(gr['id'])
  posts_limit = 10
  posts_skipped = 0
  public_group = 0
  group_id = 0
  gall_counts = {}
  if not request.args.get('grp') is None:
    thisgroup = get_one_by( 'groups', request.args.get('grp'), 'key' )
    if len(thisgroup) > 0:
      if int(thisgroup[0]['public']) > 0:
        public_group = thisgroup[0]['id']
  if not request.args.get('grpid') is None:
    thisgroup = get_one( 'groups', request.args.get('grpid') )
    group_id = thisgroup[0]['id']
  for item in recs:
    is_public = False
    if not item['inreplyto'] == '':
      continue
    if public_group > 0:
      grps = json.loads(item['groups'])
      if len(grps) > 0:
        if grps[0] == public_group:
          is_public = True
    if can('get','posts',user,item) or is_public:
      item['author'] = get_user(item['user_id'])['name']
      item['to'] = ''
      item['imageHidden'] = False
      item['allowDownload'] = False
      item['isOwner'] = False
      item['textHidden'] = True
      item['showCommentField'] = False
      item['comments'] = []
      item['published'] = item['created']
      item['isHtml'] = False
      comms = get_one_by('posts',item['id'],'inreplyto')
      for comm in list(reversed(comms)):
        comm['author'] = get_user(comm['user_id'])['name']
        item['comments'].append(comm)
      if item['image'] == '':
        item['imageHidden'] = True
      item['soundHidden'] = False
      if item['sound'] == '':
        item['soundHidden'] = True
      if item['image'] == '' and item['sound'] == '':
        item['textHidden'] = False
        if item['title'] == '':
          item['title'] = '(untitled)'
      item['isVideo'] = False
      if not item['video'] == '':
        item['imageHidden'] = True
        item['isVideo'] = True
      pgrps = json.loads(item['groups'])
      if public_group > 0:
        if not public_group in pgrps:
          continue
      if group_id > 0:
        if not group_id in pgrps:
          continue
      for p in pgrps:
        if p in allowdownload:
          item['allowDownload'] = True
      if 'id' in user:
        if int(user['id']) == int(item['user_id']):
          item['isOwner'] = True
      gall_limit = False
      for pgrp in pgrps:
        if pgrp in groups:
          thisgroup = get_one( 'groups', pgrp )
          if len(thisgroup) > 0:
            item['to'] = thisgroup[0]['name']
            item['toid'] = thisgroup[0]['id']
          if thisgroup[0]['id'] in gall_counts:
            gall_counts[thisgroup[0]['id']] = gall_counts[thisgroup[0]['id']] + 1
            #if gall_counts[thisgroup[0]['id']] > 0:
            #  gall_limit = True
          else:
            gall_counts[thisgroup[0]['id']] = 1
        if not pgrp in cangrps and not pgrp in ugrids and pgrp in groups:
          cangrps.append(pgrp)
      if not request.args.get('cursor') is None:
        if posts_skipped < int(request.args.get('cursor')):
          if not gall_limit or not request.args.get('grpid') is None:
            posts_skipped = posts_skipped + 1
        else:
          if not gall_limit or not request.args.get('grpid') is None:
            posts.append(item)
      else:
        if not gall_limit or not request.args.get('grpid') is None:
          posts.append(item)
      if len(posts) == posts_limit:
        break
    if expired(item):
      notify_del(item['user_id'])
      img = appdir + 'myfiles/' + item['image']
      if os.path.exists(img) and not item['image'] == '':
        os.remove(img)
      mus = appdir + 'myfiles/' + item['sound']
      if os.path.exists(mus) and not item['sound'] == '':
        os.remove(mus)
      del_one( 'posts', item['id'] )
  contacts = get_all('contacts')
  for cgrp in cangrps:
    newrec = {
      'title' : 'this is an example <a href="/">link</a>',
      'image' : '',
      'sound' : '',
      'groups' : '',
      'user_id' : '',
      'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) ),
      'imageHidden' : True,
      'soundHidden' : True,
      'textHidden' : False
    }
    #posts.append(newrec)
  abils = []
  grps = []
  for grp in groups:
    group = get_one( 'groups', grp )
    groupname = ''
    ispublic = False
    if len(group) > 0:
      groupname = group[0]['name']
      if not int(group[0]['user_id']) == int(user['id']):
        continue
      if 'public' in group[0]:
        if not group[0]['public'] is None:
          if int(group[0]['public']) > 0:
            ispublic = True
      glabel = ''
      comma = ''
      for con in contacts:
        if not con['groups'] is None:
          cgrps = json.loads(con['groups'])
          if grp in cgrps and not grp == 2:
            glabel = glabel + comma + con['name']
            comma = ', '
      if ispublic == False:
        grpnam = groupname + ': ' + glabel
      else:
        grpnam = groupname
      if not grpnam == '':
        grps.append({'value':grp,'label':grpnam})
    for abb in abilities:
      if abb['group_id'] == grp:
        for act in abb['actions']:
          abils.append(act + abb['resource'])
  feeds = []
  items = []
  if 'user' in session:
    settings = get_one_by( 'settings', session['user'], 'user_id' )
    if len(settings) > 1:
      for it in settings:
        if it['name'] == 'feedSubs':
          feeds = json.loads(it['value'])
  if request.args.get('grpid') is None:
    for fd in feeds:
      feed = feedparser.parse(fd)
      for item in feed.entries:
        item['imageHidden'] = True
        item['textHidden'] = False
        item['soundHidden'] = True
        item['isHtml'] = True
        if 'enclosures' in item:
          if len(item['enclosures']) > 0:
            if 'href' in item['enclosures'][0]:
              if 'type' in item['enclosures'][0]:
                item['media'] = html.unescape(item['enclosures'][0]['href'])
                item['mediatype'] = item['enclosures'][0]['type']
                item['isVideo'] = False
                if 'mp3' in item['enclosures'][0]['href']:
                  item['soundHidden'] = False
                elif any([substring in item['enclosures'][0]['href'].lower() for substring in ['.mov','.mp4']]):
                  item['textHidden'] = True
                  item['isVideo'] = True
                  print(item['media'])
                else:
                  item['imageHidden'] = False
        if not 'title' in item:
          if 'description' in item:
            item['title'] = item['description']
          else:
            if 'content' in item:
              item['title'] = item['content']
            else:
              continue
        if item['title'] == '':
          item['title'] = '(untitled)'
        upd = item['published']
        if 'published_parsed' in item:
          upd = datetime.fromtimestamp(round(time.mktime(item['published_parsed'][:8] + (-1,))))
        elif 'updated_parsed' in item:
          upd = datetime.fromtimestamp(round(time.mktime(item['updated_parsed'][:8] + (-1,))))
        item['published'] = str(upd)
        items.append(item)
    print( 'POSTS ' + str(len(posts)) + ' and ITEMS ' + str(len(items)))
    posts = posts + items
  posts.sort(key=lambda p: p['published'], reverse=True)
  following = []
  for pgrp in groups:
    if not pgrp in ugrids:
      group = get_one( 'groups', pgrp )
      groupname = ''
      if len(group) > 0:
        groupname = group[0]['name']
        mysett = {
          'name':groupname,
          'id':group[0]['id'],
          'phone':True,
          'email':True,
          'freq':2,
          'interval':'Day',
          'last_notif':str( timezone( 'US/Pacific' ).localize( datetime.now() - timedelta(hours=25) ) )
        }
        settkey = 'group_' + str(group[0]['id'])
        items = get_one_by( 'settings', settkey, 'name' )
        for sett in items:
          if int(session['user']) == int(sett['user_id']):
            mysett = json.loads(sett['value'])
            mysett['name'] = groupname
            mysett['id'] = group[0]['id']
            mysett['freq'] = int(mysett['freq'])
            if mysett['phone'] == '1':
              mysett['phone'] = True
            else:
              mysett['phone'] = False
            if mysett['email'] == '1':
              mysett['email'] = True
            else:
              mysett['email'] = False
        following.append(mysett)
  return( json.dumps( [posts,grps,abils,user['code'],cangrps,following] ) )

@app.route('/dropFeed',methods=['GET','POST'])
def dropFeed():
  if not 'user' in session:
    return json.dumps([])
  feeds = []
  items = get_one_by( 'settings', session['user'], 'user_id' )
  for it in items:
    if it['name'] == 'feedSubs':
      feeds = json.loads(it['value'])
      sid = it['id']
      for idx, fe in enumerate(feeds):
        if int(request.form.get('feed')) == idx:
          feeds.remove(fe)
          mod_one('settings',{'value':json.dumps(feeds)},sid)
  return json.dumps(feeds)

@app.route('/addFeeds',methods=['GET','POST'])
def addFeeds():
  if not 'user' in session:
    return json.dumps([])
  items = get_one_by( 'settings', session['user'], 'user_id' )
  if not len(items) > 1:
    sett = add_one('settings',{
      'name':'feedSubs',
      'value':'[]',
      'user_id':session['user']
    })
  items = get_one_by( 'settings', session['user'], 'user_id' )
  feeds = []
  sid = 0
  for it in items:
    if it['name'] == 'feedSubs':
      feeds = json.loads(it['value'])
      sid = it['id']
      feeds.append(request.form.get('feed'))
      mod_one('settings',{'value':json.dumps(feeds)},sid)
  return json.dumps(feeds)

@app.route('/addPosts',methods=['GET','POST'])
def addPosts():
  maxRes = 0
  curr = current_user()
  saveImage = [saveFile( 'image' )]
  senditems = []
  imageupl = saveFile('imagemulti')
  title = request.form.get('title')
  firstimg = ''
  if len(imageupl) > 0:
    saveImage = json.loads(imageupl)
  if not can('add','posts',curr):
    return( json.dumps( [ 'Error' ] ) )
  for savedImage in saveImage:
    if firstimg == '':
      firstimg = savedImage
    soundFile = saveFile( 'sound' )
    videoFile = ''
    if (savedImage[-7:].lower() in ['mov.jpg','mp4.jpg']):
      videoFile = savedImage[:-4]
    if (savedImage[-3:].lower() in ['mp3']):
      soundFile = savedImage
      savedImage = ''
    in_reply_to = ''
    if not request.form.get('inreplyto') is None:
      in_reply_to = request.form.get('inreplyto')
    newrec = {
      'title' : title,
      'image' : savedImage,
      'sound' : soundFile,
      'video' : videoFile,
      'groups' : request.form.get('recips'),
      'inreplyto' : in_reply_to,
      'user_id' : session['user'],
      'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
    }
    if (newrec['sound'][-3:] == 'mp3'):
      #speedup = request.form.get('speedup')
      speedup = 0.9
      sound = AudioSegment.from_file(appdir + 'myfiles/' + newrec['sound'])
      sound_with_altered_frame_rate = sound._spawn(sound.raw_data, overrides={"frame_rate": int(sound.frame_rate * float(speedup))})
      sound_with_altered_frame_rate.export(appdir + 'myfiles/' + newrec['sound'], format="mp3")
    if (int(request.form.get('expirehours')) > 0):
      now_plus_hours = datetime.now() + timedelta(hours=int(request.form.get('expirehours')))
      newrec['expires'] = str( timezone( 'US/Pacific' ).localize( now_plus_hours ) )
    if not len(in_reply_to) > 0:
      for g in json.loads(request.form.get('recips')):
         grpdata = get_one('groups',g)
         if len(grpdata) > 0:
           if not int(curr['id']) == int(grpdata[0]['user_id']):
             return( json.dumps( [ 'Error' ] ) )
    rid = add_one( 'posts', newrec )
    if rid > 0:
      if str(request.form.get('doSetHeader')) == 'true' and firstimg is not '':
        newobj = {'image':firstimg}
        for g in json.loads(request.form.get('recips')):
          grpdata = get_one('groups',g)
          growner = get_user(grpdata[0]['user_id'])
          if int(curr['id']) == int(growner['id']):
            mod_one( 'groups', newobj, g )
      dt = timezone( 'US/Pacific' ).localize( datetime.now() )
      newrec['id'] = rid
      contacts = get_all('contacts')
      recips = []
      for con in contacts:
        if can('get','posts',con,newrec):
          grp = [value for value in json.loads(request.form.get('recips')) if value in json.loads(con['groups'])][0]
          grpdata = get_one('groups',grp)
          notifprefs = get_one_by( 'settings', 'group_' + str(grp), 'name' )
          if 'maxres' in grpdata[0]:
            if not grpdata[0]['maxres'] is None:
              maxRes = int(grpdata[0]['maxres'])
          if not 'last_notif' in grpdata[0] or grpdata[0]['last_notif'] == None:
            rid = add_one( 'groups', {'last_notif':''} )
            if rid > 0:
              del_one('groups',rid)
          if not 'key' in grpdata[0] or grpdata[0]['key'] == None:
            newobj = { 'key' : randomword(8) }
            mod_one( 'groups', newobj, grpdata[0]['id'] )
            grpdata[0]['key'] = newobj['key']
          if not 'last_notif' in grpdata[0] or grpdata[0]['last_notif'] == None:
            newobj = { 'last_notif' : str( timezone( 'US/Pacific' ).localize( datetime.now() - timedelta(hours=25) ) ) }
            mod_one( 'groups', newobj, grpdata[0]['id'] )
            grpdata[0]['last_notif'] = newobj['last_notif']
          from dateutil import tz
          tzinfos = {"-08:00": tz.gettz('US/Pacific')}
          if 'last_notif' in grpdata[0]:
            dt = parser.parse(grpdata[0]['last_notif'], tzinfos=tzinfos) + timedelta(hours=12)
            pcontact = get_parent(con['id'])
            hasprefs = False
            for nprefs in notifprefs:
              if int(nprefs['user_id']) == int(pcontact['id']):
                hasprefs = True
                notiprefs = json.loads(nprefs['value'])
                prefid = nprefs['id']
            if not hasprefs:
              if dt < timezone( 'US/Pacific' ).localize( datetime.now() ):
                notify_photo( con['id'], grpdata[0]['key'], True, True )
          else:
            interv = 24
            sendemail = False
            if int(notiprefs['email']) == 1:
              sendemail = True
            sendphone = False
            if int(notiprefs['phone']) == 1:
              sendphone = True
            if notiprefs['interval'] == 'Week':
              interv = 168
            hrs = interv / int(notiprefs['freq'])
            if 'last_notif' in notiprefs:
              dt = parser.parse(notiprefs['last_notif'], tzinfos=tzinfos) + timedelta(hours=int(hrs))
              if dt < timezone( 'US/Pacific' ).localize( datetime.now() ):
                notify_photo( con['id'], grpdata[0]['key'], sendemail, sendphone )
                notiprefs['last_notif'] = str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
                mod_one('settings',{'value':json.dumps(notiprefs)},prefid)
          recips.append( con['id'] )
      if dt < timezone( 'US/Pacific' ).localize( datetime.now() ):
        newobj = { 'last_notif' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) ) }
        mod_one( 'groups', newobj, grpdata[0]['id'] )
      item = newrec
      item['imageHidden'] = False
      item['textHidden'] = True
      if item['image'] == '':
        item['imageHidden'] = True
      item['soundHidden'] = False
      if item['sound'] == '':
        item['soundHidden'] = True
      if item['image'] == '' and item['sound'] == '':
        item['textHidden'] = False
      senditems.append(item)
      clearSession('sound')
      title = ''
  clearSession('image')
  clearSession('imagemulti')
  if maxRes > 0:
    for savedImage in saveImage:
      filepath = appdir + 'myfiles/' + savedImage
      if filepath[-3:].lower() == 'jpg' or filepath[-3:].lower() == 'jpeg':
        try:
          image=Image.open(filepath)
          original_size = max(image.size[0], image.size[1])
          if original_size >= maxRes:
            resized_file = open(filepath.split('.')[0] + '_resized.jpg', "w")
            if (image.size[0] > image.size[1]):
              resized_width = maxRes
              resized_height = int(round((maxRes/float(image.size[0]))*image.size[1])) 
            else:
              resized_height = maxRes
              resized_width = int(round((maxRes/float(image.size[1]))*image.size[0]))
            image = image.resize((resized_width, resized_height), Image.ANTIALIAS)
            image.save(resized_file, 'JPEG')
          image.save(filepath)
          image.close()
        except (AttributeError, KeyError, IndexError):
          pass
  resp = 'OK'
  if request.form.get('inreplyto') is None:
    ugrps = get_one_by( 'groups', curr['id'], 'user_id' )
    rcps = json.loads(request.form.get('recips'))
    for g in rcps:
      grpdata = get_one('groups',g)
      linkpath = '/grp/' + str(grpdata[0]['key'])
      resp = ' 📷 https://' + mydomain + linkpath
    for ug in ugrps:
      if not ug['public'] is None:
        if int(ug['public']) > 0:
          if not ug['publicGroups'] is None:
            for g in json.loads(ug['publicGroups']):
              if g in rcps:
                linkpath = '/grp/' + str(ug['key'])
                if not ug['publicPath'] == '':
                  linkpath = '/' + ug['publicPath']
                resp = ' 📷 #shareinanewway #rplyphoto #rplyshare https://' + mydomain + linkpath
                if str(request.form.get('doSetHeader')) == 'true' and firstimg is not '':
                  newobj = {'image':firstimg}
                  mod_one( 'groups', newobj, ug['id'] )
                break
  response = make_response(json.dumps( [ resp ] ))
  for item in senditems:
    item['author'] = get_user(item['user_id'])['name']
    sendcomet(recips,item)
  if not request.form.get('inreplyto') is None:
    for grp in json.loads(request.form.get('recips')):
      notify_comment( grp, curr['name'] )
  return response

@app.route('/modPosts',methods=['GET','POST'])
def modPosts():
  item = get_one( 'posts', request.form.get('id') )[0]
  if not can('mod','posts',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  newobj = {
    'title' : request.form.get('title'),
    'image' : saveFile( 'image' ),
    'sound' : saveFile( 'sound' )
  }
  if newobj['image'] == '':
    del newobj['image']
  if newobj['sound'] == '':
    del newobj['sound']
  if mod_one( 'posts', newobj, request.form.get('id') ):
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/delPosts',methods=['GET','POST'])
def delPosts():
  item = get_one( 'posts', request.form.get('id') )[0]
  if not can('del','posts',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  if del_one( 'posts', request.form.get('id') ):
    img = appdir + 'myfiles/' + item['image']
    if os.path.exists(img) and not item['image'] == '':
      os.remove(img)
    mus = appdir + 'myfiles/' + item['sound']
    if os.path.exists(mus) and not item['sound'] == '':
      os.remove(mus)
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/getGroups',methods=['GET','POST'])
def getGroups():
  user = current_user()
  recs = get_all('groups')
  items = []
  groups = json.loads(user['groups'])
  othergrps = []
  for item in recs:
    if can('get','groups',user,item) or item['id'] in groups:
      item['isOwner'] = False
      if 'id' in user:
        if int(user['id']) == int(item['user_id']):
          item['isOwner'] = True
          items.append(item)
        else:
          growner = get_user(item['user_id'])
          if 'name' in growner:
            item['name'] = item['name'] + ' - ' + growner['name']
          othergrps.append(item)
  contacts = get_all('contacts')
  abils = []
  grps = []
  for grp in groups:
    group = get_one( 'groups', grp )
    groupname = ''
    if len(group) > 0:
      groupname = group[0]['name']
      if not int(group[0]['user_id']) == int(user['id']):
        continue
    glabel = ''
    comma = ''
    for con in contacts:
      if not con['groups'] == None:
        cgrps = json.loads(con['groups'])
        if grp in cgrps and not con['name'] == 'Me':
          glabel = glabel + comma + con['name']
          comma = ', '
      if not glabel == '':
        grps.append({'value':grp,'label':groupname + ': ' + glabel})
    for abb in abilities:
      if abb['group_id'] == grp:
        for act in abb['actions']:
          abils.append(act + abb['resource'])
  return( json.dumps( [items + othergrps,grps,abils,user['code']] ) )

@app.route('/joinGroup',methods=['GET','POST'])
def joinGroup():
  os.chdir(appdir)
  authd = ''
  member = ''
  groups = []
  if 'user' in session:
    if int(session['user']) > 0:
      authd = 'AUTHED'
  items = get_one_by( 'groups', request.form.get('grp'), 'key' )
  if not len(items) > 0:
    items = get_one( 'groups', request.form.get('grp') )
  result = []
  if len(items) > 0:
    if 'user' in session:
      if int(session['user']) > 0:
        curr = current_user()
        groups = json.loads(curr['groups'])
        if int(items[0]['id']) in groups:
          member = 'MEMBER'
    owner = get_user(items[0]['user_id'])
    imgsrc = ''
    if not items[0]['image'] is None:
      imgsrc = 'https://' + mydomain + '/grpFile?field=image&name=' + items[0]['image']
    publicData = '{}'
    if not items[0]['public'] is None:
      if int(items[0]['public']) > 0:
        linkedgrps = []
        linked = json.loads(items[0]['publicGroups'])
        for grp in linked:
          grpdata = get_one('groups',grp)
          if len(grpdata) > 0:
            if not grpdata[0]['image'] is None:
              linkedgrps.append({'grp':grpdata[0]['key'],'name':grpdata[0]['name'],'image':'https://' + mydomain + '/grpFile?field=image&name=' + grpdata[0]['image']})
        publicData = json.dumps({
          'publicImage':items[0]['publicImage'],
          'publicName':items[0]['publicName'],
          'publicBio':items[0]['publicBio'],
          'publicLink':items[0]['publicLink'],
          'publicGroups':linkedgrps
        })
    result = [owner['name'],items[0]['name'],imgsrc,authd,items[0]['id'],member,publicData]
  return json.dumps(result)

@app.route('/addGroups',methods=['GET','POST'])
def addGroups():
  if not can('add','groups',current_user()):
    return( json.dumps( [ 'Error' ] ) )
  newrec = {
    'name' : request.form.get('name'),
    'image' : '',
    'key':randomword(8),
    'maxres' : '0',
    'key':randomword(8),
    'allowPosts' : '0',
    'blockDownloads' : '0',
    'public':'0',
    'publicImage': saveFile( 'publicImage' ),
    'publicName': request.form.get('publicName'),
    'publicBio': request.form.get('publicBio'),
    'publicLink': request.form.get('publicLink'),
    'publicPath': request.form.get('publicPath'),
    'publicGroups': request.form.get('publicGroups'),
    'user_id' : session['user'],
    'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
  }
  if str(request.form.get('public')) == 'true':
    newrec['public'] = '1'
  if not '' == newrec['publicPath']:
    reserved = []
    for rule in app.url_map.iter_rules():
      reserved.append(rule.endpoint)
    if newrec['publicPath'] in reserved:
      return 'Error'
    grps = get_one_by( 'groups', newrec['publicPath'], 'publicPath' )
    if len(grps) > 0:
      return 'Error'
  rid = add_one( 'groups', newrec )
  grps = json.loads(get_user(current_user()['id'])['groups'])
  grps.append(rid)
  mod_one('contacts',{'groups': json.dumps(grps)},current_user()['id'])
  if rid > 0:
    clearSession('image')
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/modGroups',methods=['GET','POST'])
def modGroups():
  item = get_one( 'groups', request.form.get('id') )[0]
  curr = current_user()
  if not can('mod','groups',curr,item):
    return( json.dumps( [ 'Error' ] ) )
  if not 'image' in item or not 'key' or not 'maxres' in item or not 'allowPosts' in item or not 'blockDownloads' in item:
    rid = add_one( 'groups', {'image':'','key':'','maxres':'2000','allowPosts':'0','blockDownloads':'1'} )
    if rid > 0:
      del_one('groups',rid)
  scale = '0'
  if (int(request.form.get('maxres')) > 0):
    scale = request.form.get('maxres')
  newobj = {
    'name' : request.form.get('name'),
    'image' : saveFile( 'image' ),
    'maxres' : scale,
    'allowPosts' : '0',
    'blockDownloads' : '0',
    'public':'0',
    'publicImage': saveFile( 'publicImage' ),
    'publicName': request.form.get('publicName'),
    'publicBio': request.form.get('publicBio'),
    'publicLink': request.form.get('publicLink'),
    'publicGroups': request.form.get('publicGroups'),
    'publicPath': request.form.get('publicPath')
  }
  if str(request.form.get('allowPosts')) == 'true':
    newobj['allowPosts'] = '1'
  if str(request.form.get('blockDownloads')) == 'true':
    newobj['blockDownloads'] = '1'
  if str(request.form.get('public')) == 'true':
    newobj['public'] = '1'
  if newobj['image'] == '':
    del newobj['image']
  if newobj['publicImage'] == '':
    del newobj['publicImage']
  reserved = []
  for rule in app.url_map.iter_rules():
    reserved.append(rule.endpoint)
  if not item['publicPath'] == newobj['publicPath']:
    if newobj['publicPath'] in reserved:
      return 'Error'
    grps = get_one_by( 'groups', newobj['publicPath'], 'publicPath' )
    for chckgrp in grps:
      if not chckgrp['id'] == item['id']:
        return 'Error'
  if not 'key' in item or item['key'] == None:
    newobj['key'] = randomword(8)
    item['key'] = newobj['key']
  if mod_one( 'groups', newobj, request.form.get('id') ):
    items = get_one_by( 'groups', curr['id'], 'user_id' )
    if len(items) == 1:
      savedImage = saveFile( 'image' )
      in_reply_to = ''
      newrec = {
        'title' : '',
        'image' : savedImage,
        'sound' : '',
        'video' : '',
        'groups' : json.dumps([int(request.form.get('id'))]),
        'inreplyto' : in_reply_to,
        'user_id' : session['user'],
        'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
      }
      rid = add_one( 'posts', newrec )
    clearSession('image')
    clearSession('publicImage')
    return( 'https://' + mydomain + '/grp/' + item['key'] )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/delGroups',methods=['GET','POST'])
def delGroups():
  item = get_one( 'groups', request.form.get('id') )[0]
  if not can('del','groups',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  if del_one( 'groups', request.form.get('id') ):
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/getContacts',methods=['GET','POST'])
def getContacts():
  user = current_user()
  recs = get_all('contacts')
  items = []
  for item in recs:
    if can('get','contacts',user,item):
      if not item['name'] == None and not item['user_id'] == None:
        items.append(item)
  contacts = get_all('contacts')
  groups = json.loads(user['groups'])
  abils = []
  grps = []
  for grp in groups:
    glabel = ''
    comma = ''
    for con in contacts:
      if not con['groups'] == None:
        cgrps = json.loads(con['groups'])
        if grp in cgrps and not con['name'] == 'Me':
          glabel = glabel + comma + con['name']
          comma = ', '
      if not glabel == '':
        grps.append({'value':grp,'label':glabel})
    for abb in abilities:
      if abb['group_id'] == grp:
        for act in abb['actions']:
          abils.append(act + abb['resource'])
  return( json.dumps( [items,grps,abils,user['code']] ) )

@app.route('/addContacts',methods=['GET','POST'])
def addContacts():
  if not can('add','contacts',current_user()):
    return( json.dumps( [ 'Error' ] ) )
  ra = randomword(6)
  newph = ''.join(re.findall(r'[0-9]+', request.form.get('phone')))
  if len(newph) == 11:
    newph = newph[1:]
  newrec = {
    'name' : request.form.get('name'),
    'email' : request.form.get('email'),
    'phone' : newph,
    'groups' : request.form.get('recips'),
    'code':ra,
    'user_id' : session['user'],
    'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
  }
  rid = add_one( 'contacts', newrec )
  if rid > 0:
    share_my_contact(newrec,[])
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/quickAddContacts',methods=['GET','POST'])
def quickAddContacts():
  if not can('add','contacts',current_user()):
    return( json.dumps( [ 'Error' ] ) )
  ra = randomword(6)
  newph = ''.join(re.findall(r'[0-9]+', request.form.get('phone')))
  if len(newph) == 11:
    newph = newph[1:]
  user = current_user()
  groups = json.loads(user['groups'])
  newrec = {
    'name' : request.form.get('name'),
    'email' : request.form.get('email'),
    'phone' : newph,
    'groups' : json.dumps([groups[1]]),
    'code':ra,
    'user_id' : session['user'],
    'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
  }
  rid = add_one( 'contacts', newrec )
  if rid > 0:
    share_my_contact(newrec,[])
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/doJoin',methods=['GET','POST'])
def doJoin():
  if request.form.get("phone") == '' and request.form.get("email") == '':
    grpdata = get_one_by( 'groups', request.form.get('grp'), 'key' )
    if 'user_id' in grpdata[0]:
      addgrp = grpdata[0]['id']
      growner = get_user(grpdata[0]['user_id'])
      share_my_contact(growner,[addgrp])
    return 'OK'
  items = get_one_by( 'groups', request.form.get('grp'), 'key' )
  ra = randomword(6)
  newph = ''.join(re.findall(r'[0-9]+', request.form.get('phone')))
  if len(newph) == 11:
    newph = newph[1:]
  cont = {}
  cont['phone'] = newph
  cont['email'] = request.form.get("email")
  cont['name'] = request.form.get("name")
  newuser = ''
  if len(cont['phone']) > 0:
    loginuser = cont['phone']
    usr = get_one_by('contacts',loginuser,'phone')
  if len(cont['email']) > 0:
    loginuser = cont['email']
    usr = get_one_by('contacts',loginuser,'email')
  num = randint(100, 999)
  cont = {}
  cont['phone'] = request.form.get("phone")
  cont['email'] = request.form.get("email").lower()
  add_one('connectcodes',{
    'num':num,
    'email':cont['email'],
    'phone':cont['phone']
  })
  if len(cont['phone']) > 0:
    client = Client(twilio_id, twilio_token)
    rl = "Your " + mydomain + " code is " + str(num)
    message = client.messages.create(
      body=rl,
      from_='+1' + os.getenv('TWILIO_FROM'),
      to=cont['phone']
    )
  if len(cont['email']) > 0:
    em = cont['email']
    message = Mail(
      from_email=os.getenv('SENDGRID_FROM'),
      to_emails=em,
      subject='Your ' + mydomain + ' connection code is ' + str(num),
      html_content='<strong>Your code is ' + str(num) + '</strong>')
    sg = SendGridAPIClient(sendgrid_token)
    response = sg.send(message)
  return 'OK'
  newrec = {
    'name' : request.form.get('name'),
    'email' : request.form.get('email'),
    'phone' : newph,
    'groups' : json.dumps([items[0]['id']]),
    'code':ra,
    'user_id' : items[0]['user_id'],
    'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
  }
  rid = add_one( 'contacts', newrec )
  if rid > 0:
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/modContacts',methods=['GET','POST'])
def modContacts():
  item = get_one( 'contacts', request.form.get('id') )[0]
  if not can('mod','contacts',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  newph = ''.join(re.findall(r'[0-9]+', request.form.get('phone')))
  if len(newph) == 11:
    newph = newph[1:]
  newobj = {
    'name' : request.form.get('name'),
    'email' : request.form.get('email'),
    'phone' : newph
  }
  if mod_one( 'contacts', newobj, request.form.get('id') ):
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/modContactGroups',methods=['GET','POST'])
def modContactGroups():
  item = get_one( 'contacts', request.form.get('id') )[0]
  if not can('mod','contacts',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  newobj = {
    'groups' : request.form.get('groups')
  }
  mod_one( 'contacts', newobj, request.form.get('id') )
  contacts = get_all('contacts')
  user = current_user()
  groups = json.loads(user['groups'])
  grps = []
  for grp in groups:
    group = get_one( 'groups', grp )
    groupname = ''
    if len(group) > 0:
      groupname = group[0]['name']
      if not int(group[0]['user_id']) == int(user['id']):
        continue
    glabel = ''
    comma = ''
    for con in contacts:
      if not con['groups'] is None:
        cgrps = json.loads(con['groups'])
        if grp in cgrps and not grp == 2:
          glabel = glabel + comma + con['name']
          comma = ', '
    if not glabel == '':
      grps.append({'value':grp,'label':groupname + ': ' + glabel})
  update_abilities()
  return( json.dumps( [ grps ] ) )

@app.route('/delContacts',methods=['GET','POST'])
def delContacts():
  item = get_one( 'contacts', request.form.get('id') )[0]
  if not can('del','contacts',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  if del_one( 'contacts', request.form.get('id') ):
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/uploadFile',methods=['GET','POST'])
def uploadFile():
  filedata = {}
  if not os.path.exists(appdir + 'myfiles'):
    os.makedirs(appdir + 'myfiles')
  if request.method == 'POST':
    if (sys.getsizeof(request.get_data()) > 5000):
      fi = tempfile.NamedTemporaryFile(delete=False)
      f = open(fi.name, 'w+b')
      f.write(request.get_data())
      f.close()
      filedata['tmp_name'] = fi.name
      filedata['name'] = time.strftime("%d_%m_%Y_%H_%M_%S_") + '.mp3'
    if 'file' in request.files:
      file = request.files['file']
      if not file.filename == '':
        if file and allowed_file(file.filename):
          fi = tempfile.NamedTemporaryFile(delete=False)
          file.save(fi.name)
          filedata['tmp_name'] = fi.name
          filedata['name'] = file.filename
  if 'name' in filedata:
    fname = time.strftime("%Y%m%d-%H%M%S") + filedata['name']
    filepath = appdir + 'myfiles/' + fname
    copyfile(filedata['tmp_name'], filepath)
    if not (filepath[-3:] == 'mp3'):
      try:
        image=Image.open(filepath)
        for orientation in ExifTags.TAGS.keys():
          if ExifTags.TAGS[orientation]=='Orientation':
            break
        exif=dict(image._getexif().items())
        if exif[orientation] == 3:
          image=image.rotate(180, expand=True)
        elif exif[orientation] == 6:
          image=image.rotate(270, expand=True)
        elif exif[orientation] == 8:
          image=image.rotate(90, expand=True)
        image.save(filepath)
        image.close()
      except (AttributeError, KeyError, IndexError):
        # cases: image don't have getexif
        pass
    response = make_response(json.dumps( [ 'OK' ] ))
    setSession(request.args.get('field'),fname)
    return response
  return 'OK'

@app.route('/uploadMulti',methods=['GET','POST'])
def uploadMulti():
  filedata = {}
  filenames = []
  uploaded = []
  if not os.path.exists(appdir + 'myfiles'):
    os.makedirs(appdir + 'myfiles')
  if request.method == 'POST':
    if not request.files.getlist('photos') is None:
      files = request.files.getlist('photos')
      for file in files:
        if file and allowed_file(file.filename):
          fi = tempfile.NamedTemporaryFile(delete=False)
          file.save(fi.name)
          filedata['tmp_name'] = fi.name
          filedata['name'] = file.filename
          if 'name' in filedata:
            fname = time.strftime("%Y%m%d-%H%M%S") + filedata['name']
            filepath = appdir + 'myfiles/' + fname
            copyfile(filedata['tmp_name'], filepath)
            if filepath[-3:].lower() in ['mov','mp4']:
              if filepath[-3:].lower() == 'mov':
                outfile = filepath.lower().replace('.mov','.mp4')
                fname = fname.lower().replace('.mov','.mp4')
                command = [
                  'ffmpeg',
                  '-i', filepath,
                  '-q:v', '0',
                  '-strict', '-2',
                  '-y', '-hide_banner',
                  '-nostats',
                  '-loglevel', 'quiet',
                  outfile ]
                pipe = subprocess.call( command )
                filepath = outfile
              uploaded.append({'url':fname + '.jpg','originalName':filedata['name'] + '.jpg'})
              filenames.append(fname + '.jpg')
            else:
              uploaded.append({'url':fname,'originalName':filedata['name']})
              filenames.append(fname)
            if filepath[-3:].lower() in ['mov','mp4']:
              vidcap = cv2.VideoCapture(filepath)
              success,image = vidcap.read()
              filepath = filepath + '.jpg'
              cv2.imwrite(filepath, image)
              image=Image.open(filepath)
              #image=image.rotate(180, expand=True)
              image.save(filepath)
              image.close()
            if not (filepath[-3:] == 'mp3'):
              try:
                image=Image.open(filepath)
                for orientation in ExifTags.TAGS.keys():
                  if ExifTags.TAGS[orientation]=='Orientation':
                    break
                exif=dict(image._getexif().items())
                if exif[orientation] == 3:
                  image=image.rotate(180, expand=True)
                elif exif[orientation] == 6:
                  image=image.rotate(270, expand=True)
                elif exif[orientation] == 8:
                  image=image.rotate(90, expand=True)
                image.save(filepath)
                image.close()
              except (AttributeError, KeyError, IndexError):
                # cases: image don't have getexif
                pass
    response = make_response(json.dumps( [ uploaded ] ))
    setSession('imagemulti',json.dumps(filenames))
    return response
  return 'OK'

@app.route('/stagedFile',methods=['GET','POST'])
def stagedFile():
  return(saveFile(request.args.get('field')))

@app.route('/grpFile',methods=['GET','POST'])
def grpFile():
  thefile = False
  item = get_one_by( 'groups', request.args.get('name'), request.args.get('field') )
  if len(item) > 0:
    thefile = appdir + 'myfiles/' + item[0][request.args.get('field')]
    ftype = 'image/jpeg'
    print(thefile,file=sys.stderr)
    return send_file( thefile, mimetype=ftype)
  else:
    return 'Error'

@app.route('/myFile',methods=['GET','POST'])
def myFile():
  thefile = False
  if not request.args.get('staged') is None:
    if not request.args.get('multiname') is None:
      thefile = appdir + 'myfiles/' + request.args.get('multiname')
    else:
      if not saveFile(request.args.get('field')) == '':
        thefile = appdir + 'myfiles/' + saveFile(request.args.get('field'))
      else:
        item = get_one_by( 'groups', request.args.get('name'), request.args.get('field') )
        if len(item) > 0:
          thefile = appdir + 'myfiles/' + item[0][request.args.get('field')]
  else:
    item = get_one_by( 'posts', request.args.get('name'), request.args.get('field') )
    if len(item) > 0:
      thefile = appdir + 'myfiles/' + item[0][request.args.get('field')]
  ftype = 'image/jpeg'
  if thefile and not os.path.isdir(thefile):
    if (thefile[-3:].lower() == 'mp3'):
      ftype = 'audio/mp3'
    if (thefile[-3:].lower() in ['mov','mp4']):
      return send_from_directory(appdir + 'myfiles/', request.args.get('name'), conditional=True)
    print(thefile,file=sys.stderr)
    return send_file( thefile, mimetype=ftype)
  return 'Error'

abilities = [
  {
    'group_id':2,
    'resource':'posts',
    'actions':['add']
  },
  {
    'group_id':2,
    'resource':'posts',
    'actions':['get'],
    'conditions':[['groups','groups']]
  },
  {
    'group_id':2,
    'resource':'posts',
    'actions':['mod','del'],
    'conditions':[['user_id','id']]
  },
  {
    'group_id':2,
    'resource':'contacts',
    'actions':['add']
  },
  {
    'group_id':2,
    'resource':'contacts',
    'actions':['get'],
    'conditions':[['user_id','id']]
  },
  {
    'group_id':2,
    'resource':'contacts',
    'actions':['mod','del'],
    'conditions':[['user_id','id']]
  },
  {
    'group_id':2,
    'resource':'groups',
    'actions':['add']
  },
  {
    'group_id':2,
    'resource':'groups',
    'actions':['get'],
    'conditions':[['user_id','id']]
  },
  {
    'group_id':2,
    'resource':'groups',
    'actions':['mod','del'],
    'conditions':[['user_id','id']]
  }
]

  </script>
</html>

